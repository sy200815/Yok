<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yok Chat</title>
    <style>
        :root {
            --bg-color: #DCE9F5;       /* é›¾éœ¾è“èƒŒæ™¯ */
            --card-bg: rgba(255, 255, 255, 0.85); /* åŠé€æ˜ç™½ */
            --text-main: #5A6A7E;      /* æ·±ç°è“å­—ä½“ */
            --text-light: #8B9BB4;     /* æµ…ç°è“å­—ä½“ */
            --accent: #7FA6C8;         /* å¼ºè°ƒè‰² */
            --shadow: 0 8px 20px rgba(127, 166, 200, 0.15);
        }

        body {
            font-family: 'Helvetica Neue', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            height: 100vh; /* å æ»¡å…¨å± */
            width: 100vw;
            overflow: hidden; /* ç¦æ­¢æ»šåŠ¨ */
            display: flex;
            flex-direction: column;
            align-items: center;
            color: var(--text-main);
            user-select: none; /* ç¦æ­¢é€‰ä¸­æ–‡å­—ï¼ŒåƒAppä¸€æ · */
        }

        /* --- èƒŒæ™¯ä¸å¤´åƒåŒºåŸŸ --- */
        #wallpaper-layer {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            background-color: var(--bg-color);
        }
        
        /* å¤´åƒæ¡† */
        #avatar-box {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background-color: white;
            margin-top: 120px; /* è·ç¦»é¡¶éƒ¨è·ç¦» */
            box-shadow: var(--shadow);
            border: 3px solid white;
            background-size: cover;
            background-position: center;
            cursor: pointer;
            position: relative;
            z-index: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 12px;
            color: var(--text-light);
            overflow: hidden;
        }

        /* --- çŠ¶æ€æ  --- */
        #status-bar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 12px;
            font-weight: bold;
            color: var(--text-main);
            z-index: 100;
        }
        .battery-icon {
            width: 24px; height: 12px;
            border: 1.5px solid var(--text-main);
            border-radius: 3px;
            position: relative;
            display: flex;
            align-items: center;
            padding: 1px;
        }
        .battery-icon::after { /* ç”µæ± å¤´ */
            content: '';
            position: absolute; right: -4px; top: 2px;
            width: 2px; height: 4px;
            background: var(--text-main);
            border-radius: 0 1px 1px 0;
        }
        .battery-level {
            height: 100%;
            background-color: var(--text-main);
            border-radius: 1px;
            width: 50%; /* é»˜è®¤ç”µé‡ */
        }

        /* --- ä¸»å±å¹•æ—¶é—´ --- */
        #main-clock {
            margin-top: 20px;
            font-size: 48px;
            font-weight: 300;
            color: var(--text-main);
            text-shadow: 0 2px 10px rgba(255,255,255,0.5);
            z-index: 1;
        }

        /* --- åº”ç”¨ç½‘æ ¼ --- */
        #app-grid {
            margin-top: 40px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            width: 90%;
            z-index: 1;
        }

        .app-icon {
            width: 60px; height: 60px;
            background: white;
            border-radius: 18px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            cursor: pointer;
            transition: transform 0.1s;
        }
        .app-icon:active { transform: scale(0.95); }
        .app-img { width: 30px; height: 30px; margin-bottom: 4px; }
        .app-name { font-size: 10px; color: var(--text-main); margin-top: 5px;}

        /* --- API è®¾ç½®çª—å£ (æ¨¡æ€æ¡†) --- */
        .modal {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.95);
            z-index: 200;
            display: none; /* é»˜è®¤éšè— */
            flex-direction: column;
            padding: 20px;
            box-sizing: border-box;
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 30px;
        }
        .close-btn { font-size: 24px; cursor: pointer; padding: 10px; }
        
        /* è¡¨å•æ ·å¼ */
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: bold; }
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #E0E0E0;
            border-radius: 12px;
            background: #F9F9F9;
            font-size: 14px;
            box-sizing: border-box;
            outline: none;
            color: var(--text-main);
        }
        input:focus { border-color: var(--accent); background: white; }
        
        .btn {
            background-color: var(--accent);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 12px;
            width: 100%;
            font-size: 14px;
            cursor: pointer;
            margin-top: 10px;
        }
        .btn:active { opacity: 0.8; }
        .btn-secondary { background-color: #E0E0E0; color: #666; margin-top: 0; width: auto; padding: 8px 15px;}

        /* éšè—çš„æ–‡ä»¶ä¸Šä¼ Input */
        .hidden-input { display: none; }
        
        /* --- Chat åº”ç”¨ç‰¹æœ‰æ ·å¼ --- */
        
        /* èŠå¤©åº”ç”¨çš„å®¹å™¨ä¿®æ­£ï¼Œè®©å®ƒé“ºæ»¡ä½†ç•™å‡ºçŠ¶æ€æ ä½ç½® */
        #chat-app {
            background-color: #F2F6FC; /* æ›´æµ…çš„è“ç™½è‰²èƒŒæ™¯ */
            padding: 0; /* æ¸…é™¤é»˜è®¤å†…è¾¹è· */
            display: none;
            flex-direction: column;
        }

        /* é¡¶éƒ¨æ ‡é¢˜æ  */
        .chat-header-bar {
            height: 60px;
            padding-top: 30px; /* é¿å¼€çŠ¶æ€æ  */
            padding-left: 20px;
            padding-right: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: transparent;
            flex-shrink: 0;
        }
        .chat-title { font-size: 24px; font-weight: 800; color: #4A5A6E; }
        .chat-search-icon { color: #4A5A6E; }

        /* ä¸­é—´å†…å®¹æ»šåŠ¨åŒº */
        .chat-content-area {
            flex: 1;
            overflow-y: auto;
            padding: 10px 20px;
            padding-bottom: 80px; /* ç»™åº•éƒ¨å¯¼èˆªç•™ä½ç½® */
        }

        /* èŠå¤©åˆ—è¡¨å¡ç‰‡ (ä»¿å‚è€ƒå›¾) */
        .chat-item-card {
            background: white;
            border-radius: 24px; /* è¶…å¤§åœ†è§’ */
            padding: 15px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            box-shadow: 0 4px 15px rgba(127, 166, 200, 0.08);
            transition: transform 0.1s;
            position: relative;
        }
        .chat-item-card:active { transform: scale(0.98); }
        
        .chat-avatar {
            width: 56px; height: 56px;
            border-radius: 18px; /* æ–¹å½¢åœ†è§’å¤´åƒ */
            background-color: #eee;
            background-size: cover;
            background-position: center;
            margin-right: 15px;
            border: 2px solid #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            flex-shrink: 0;
        }
        
        .chat-info { flex: 1; overflow: hidden; }
        .chat-name { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 4px; }
        .chat-preview { font-size: 13px; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .chat-time { font-size: 12px; color: #bbb; position: absolute; top: 18px; right: 20px; }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            position: absolute;
            bottom: 20px; left: 20px; right: 20px;
            height: 70px;
            background: white;
            border-radius: 35px;
            display: flex;
            justify-content: space-around; /* ç­‰è·åˆ†å¸ƒ */
            align-items: center;
            box-shadow: 0 10px 30px rgba(127, 166, 200, 0.15);
            z-index: 10;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            color: #C0C8D3;
            cursor: pointer;
            transition: color 0.2s;
        }
        .nav-item.active { color: var(--accent); }
        .nav-label { font-size: 10px; margin-top: 4px; font-weight: bold;}

        /* --- æ–°ç‰ˆ API è®¾ç½®é¡µé¢ç¾åŒ– (ä»¿å‚è€ƒå›¾é£æ ¼) --- */
        
        /* è¦†ç›–åŸæœ¬çš„æ¨¡æ€æ¡†èƒŒæ™¯ï¼Œè®©å®ƒæ›´åƒä¸€ä¸ªAPPé¡µé¢ */
        #api-settings {
            background-color: #F7F9FC; /* ææµ…çš„ç°è“è‰²èƒŒæ™¯ */
            padding: 0;
        }

        /* é¡¶éƒ¨çš„å¯¼èˆªæ¡ */
        .api-header {
            background: white;
            padding: 20px;
            padding-top: 50px; /* é¿å¼€çŠ¶æ€æ  */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 10px rgba(0,0,0,0.03);
            z-index: 10;
        }
        .api-header h2 {
            font-size: 18px;
            margin: 0;
            color: #333;
        }
        .api-back-btn {
            position: absolute;
            left: 20px;
            top: 50px;
            font-size: 24px;
            color: #333;
            cursor: pointer;
        }

        /* è®¾ç½®å†…å®¹çš„æ»šåŠ¨å®¹å™¨ */
        .api-content-scroll {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        /* ç™½è‰²å¤§å¡ç‰‡å®¹å™¨ */
        .settings-card {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(127, 166, 200, 0.08);
            margin-bottom: 20px;
        }

        /* æ ‡é¢˜æ ·å¼ */
        .setting-label {
            font-size: 15px;
            font-weight: 700;
            color: #444;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* è¾“å…¥æ¡†ç¾åŒ–ï¼šæµ…ç°è‰²åœ†è§’çŸ©å½¢ */
        .cute-input {
            width: 100%;
            background-color: #F5F7FA;
            border: 1px solid transparent;
            border-radius: 12px;
            padding: 14px 16px;
            font-size: 14px;
            color: #555;
            outline: none;
            transition: all 0.3s;
            box-sizing: border-box;
            font-family: inherit; /* ç»§æ‰¿å­—ä½“ */
        }
        .cute-input:focus {
            background-color: white;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(127, 166, 200, 0.2);
        }

        /* è¾…åŠ©è¯´æ˜æ–‡å­— */
        .helper-text {
            font-size: 12px;
            color: #999;
            margin-top: 8px;
            line-height: 1.5;
        }

        /* æ¨¡å‹é€‰æ‹©åŒºåŸŸå¸ƒå±€ */
        .model-row {
            display: flex;
            gap: 10px;
        }
        .model-select-wrapper {
            flex: 1;
            position: relative;
        }
        /* è‡ªå®šä¹‰ä¸‹æ‹‰ç®­å¤´ */
        .model-select-wrapper::after {
            content: 'â–¼';
            font-size: 10px;
            color: #999;
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        /* æŒ‰é’®ç¾åŒ– */
        .btn-refresh {
            background-color: white;
            border: 1px solid #E0E0E0;
            color: #666;
            border-radius: 12px;
            padding: 0 20px;
            font-weight: bold;
            cursor: pointer;
            white-space: nowrap;
            transition: 0.2s;
        }
        .btn-refresh:active { background-color: #f0f0f0; }

        .btn-save {
            background: linear-gradient(135deg, #7FA6C8, #6C8DAF);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 16px;
            width: 100%;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
            box-shadow: 0 8px 20px rgba(127, 166, 200, 0.3);
            cursor: pointer;
        }
        .btn-save:active { transform: scale(0.98); }

        /* æ¸©åº¦è¾“å…¥æ¡†ç‰¹æ®Šå¤„ç† */
        .temp-wrapper {
            display: flex;
            align-items: center;
            background: #F5F7FA;
            border-radius: 12px;
            padding: 5px 15px;
        }
        .temp-input-clean {
            background: transparent;
            border: none;
            font-size: 16px;
            font-weight: bold;
            color: var(--accent);
            width: 60px;
            text-align: center;
            outline: none;
        }
        
        /* --- è”ç³»äººåˆ—è¡¨æ ·å¼ --- */
        .contact-item {
            background: white;
            border-radius: 20px;
            padding: 12px 15px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            transition: transform 0.1s;
        }
        .contact-item:active { transform: scale(0.98); background-color: #fafafa; }
        
        .contact-avatar {
            width: 48px; height: 48px;
            border-radius: 16px;
            background-size: cover;
            background-position: center;
            margin-right: 15px;
            border: 1px solid #eee;
        }
        .contact-name { font-size: 15px; font-weight: bold; color: #333; }
        .contact-tag { 
            font-size: 10px; color: #7FA6C8; background: #E3F2FD; 
            padding: 2px 8px; border-radius: 10px; margin-left: 8px; 
        }

        /* --- é¡¶éƒ¨æŒ‡çº¹æŒ‰é’® --- */
        #add-contact-btn {
            display: none; /* é»˜è®¤éšè—ï¼Œåªæœ‰åˆ‡åˆ°è”ç³»äººtabæ‰æ˜¾ç¤º */
            cursor: pointer;
            color: #7FA6C8;
            padding: 5px;
            border-radius: 50%;
            transition: background 0.2s;
        }
        #add-contact-btn:active { background: rgba(127, 166, 200, 0.1); }

        /* --- æ–°ç‰ˆåˆ›å»ºè§’è‰²é¡µé¢ (è¦†ç›–å±‚) --- */
        #create-role-page {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #F2F6FC;
            z-index: 50; /* åœ¨åº•éƒ¨å¯¼èˆªä¹‹ä¸Š */
            display: none;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        .create-header {
            padding: 20px; padding-top: 50px;
            display: flex; align-items: center;
            color: #333; font-size: 18px; font-weight: bold;
        }
        .back-icon { margin-right: 15px; cursor: pointer; }

        /* ç¾åŒ–åçš„è¡¨å•å¡ç‰‡ */
        .create-card {
            background: white;
            margin: 20px;
            border-radius: 30px;
            padding: 30px 20px;
            box-shadow: 0 10px 30px rgba(127, 166, 200, 0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* æ›´æœ‰å±‚æ¬¡æ„Ÿçš„å¤´åƒä¸Šä¼  */
        .avatar-uploader {
            width: 90px; height: 90px;
            border-radius: 30px;
            background: #F7F9FC;
            border: 2px dashed #DCE9F5;
            display: flex; justify-content: center; align-items: center;
            color: #A0B0C0; font-size: 12px;
            cursor: pointer;
            margin-bottom: 25px;
            background-size: cover; background-position: center;
            transition: all 0.3s;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.02);
        }
        .avatar-uploader:active { transform: scale(0.95); border-color: var(--accent); }

        /* æ¸…çˆ½çš„è¾“å…¥è¡Œ */
        .input-row {
            width: 100%; margin-bottom: 20px;
        }
        .input-label {
            font-size: 12px; color: #8B9BB4; margin-bottom: 8px; margin-left: 5px; font-weight: bold;
        }
        .clean-input {
            width: 100%;
            background: #F7F9FC;
            border: none;
            padding: 15px;
            border-radius: 15px;
            font-size: 14px;
            color: #333;
            outline: none;
            box-sizing: border-box;
            transition: background 0.2s;
        }
        .clean-input:focus { background: #fff; box-shadow: 0 0 0 2px #DCE9F5; }

        /* æ€§åˆ«é€‰æ‹©èƒ¶å›Š */
        .gender-capsule {
            display: flex; background: #F7F9FC; border-radius: 15px; padding: 4px;
        }
        .gender-opt {
            flex: 1; text-align: center; padding: 10px 0;
            font-size: 13px; color: #8B9BB4; border-radius: 12px; cursor: pointer; transition: 0.2s;
        }
        .gender-opt.active {
            background: white; color: var(--accent); font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .create-btn-float {
            margin-top: 10px;
            width: 100%;
            background: var(--accent);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 18px;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(127, 166, 200, 0.3);
            cursor: pointer;
        }
        
        /* --- 5. èŠå¤©å®¤é¡µé¢ (æ²‰æµ¸å¼) --- */
        #chat-room-page {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #F9F9F9; /* é»˜è®¤æ›´ç™½çš„èƒŒæ™¯ */
            z-index: 60; /* æ¯”åˆ›å»ºé¡µæ›´é«˜ */
            display: none;
            flex-direction: column;
            background-size: cover;
            background-position: center;
        }

        /* èŠå¤©å®¤é¡¶éƒ¨ */
        .room-header {
            height: 50px;
            padding-top: 30px; /* é¿å¼€çŠ¶æ€æ  */
            padding-left: 15px; padding-right: 15px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(255,255,255,0.9); /* æ¯›ç»ç’ƒè¡¨å¤´ */
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            z-index: 10;
        }
        .room-info { text-align: center; flex: 1; }
        .room-name { font-size: 16px; font-weight: bold; color: #333; }
        .room-status { font-size: 10px; color: var(--accent); height: 14px; opacity: 0; transition: opacity 0.3s; }
        .room-status.typing { opacity: 1; }

        /* èŠå¤©æ¶ˆæ¯åŒºåŸŸ */
        #message-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            padding-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* æ¶ˆæ¯è¡Œ */
        .msg-row { display: flex; width: 100%; margin-bottom: 5px; }
        .msg-row.left { justify-content: flex-start; }
        .msg-row.right { justify-content: flex-end; }

        /* æ°”æ³¡åŸºç¡€æ ·å¼ */
        .msg-bubble {
            max-width: 70%;
            padding: 10px 14px;
            font-size: var(--chat-font-size, 14px); /* åŠ¨æ€å­—ä½“å¤§å° */
            line-height: 1.5;
            position: relative;
            word-wrap: break-word;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05);
        }

        /* æ°”æ³¡å½¢çŠ¶å˜ä½“ */
        .bubble-round { border-radius: 20px; } /* åœ†æ»šæ»š */
        .bubble-sharp { border-radius: 4px; }  /* ä»¿å¾®ä¿¡å°å°–è§’ (ç®€åŒ–ç‰ˆ) */
        .bubble-default { border-radius: 12px; } /* é»˜è®¤ */

        /* åº•éƒ¨è¾“å…¥æ  (ç²¾è‡´å°å·§) */
        /* --- â–¼â–¼â–¼ è¯·æ›¿æ¢æˆè¿™ä¸ª â–¼â–¼â–¼ --- */
.room-footer {
    background: white;
    padding: 8px 12px; /* ä¸Šä¸‹å·¦å³çš„è¾¹è·éƒ½æ”¹å°äº† */
    padding-bottom: 30px; /* é€‚é…å…¨é¢å±åº•éƒ¨ */
    display: flex; align-items: flex-end; gap: 8px; /* å…ƒç´ é—´è·ä¹Ÿæ”¹å° */
    box-shadow: 0 -2px 10px rgba(0,0,0,0.02);
}
        
        /* --- â–¼â–¼â–¼ è¯·æ›¿æ¢æˆè¿™ä¸ª â–¼â–¼â–¼ --- */
.chat-input-box {
    flex: 1;
    background: #F2F2F2;
    border-radius: 18px; /* åœ†è§’æ”¹å°ä¸€ç‚¹ */
    padding: 8px 15px; /* ä¸Šä¸‹å†…è¾¹è·æ”¹å° */
    max-height: 100px;
    overflow-y: auto;
    font-size: 14px;
    border: none; outline: none;
    resize: none; /* ç¦æ­¢æ‹–æ‹½ */
}

        /* --- â–¼â–¼â–¼ è¯·æ›¿æ¢æˆè¿™ä¸ª â–¼â–¼â–¼ --- */
.action-btn {
    width: 36px; height: 36px; /* æŒ‰é’®æ•´ä½“å˜å° */
    border-radius: 50%;
    display: flex; justify-content: center; align-items: center;
    cursor: pointer;
    transition: transform 0.1s;
    flex-shrink: 0;
}
        .action-btn:active { transform: scale(0.9); }
        
        /* æ¥æ”¶æŒ‰é’® (å·¦ä¾§) */
        .btn-receive { background: #F0F2F5; color: #5A6A7E; }
        /* å‘é€æŒ‰é’® (å³ä¾§) */
        .btn-send { background: var(--accent); color: white; }


        /* --- 6. èŠå¤©è®¾ç½®é¡µé¢ (ç‹¬ç«‹é¡µé¢) --- */
        #chat-settings-page {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-color: #F2F6FC;
            z-index: 70;
            display: none;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }
        
        .setting-section {
            background: white;
            margin: 15px 20px;
            border-radius: 16px;
            padding: 5px 0; /* å†…éƒ¨åˆ—è¡¨ */
            box-shadow: 0 2px 8px rgba(0,0,0,0.02);
        }
        
        .setting-item {
            padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #f5f5f5;
        }
        .setting-item:last-child { border-bottom: none; }
        .setting-title { font-size: 14px; color: #333; font-weight: 500; }
        
        /* é¢œè‰²é€‰æ‹©å™¨åœ†ç‚¹ */
        .color-dot {
            width: 24px; height: 24px; border-radius: 50%;
            border: 2px solid #eee; cursor: pointer;
            display: inline-block;
        }
        
        /* å½¢çŠ¶é€‰æ‹©å™¨ */
        .shape-selector { display: flex; gap: 10px; }
        .shape-opt {
            width: 30px; height: 30px; background: #eee; cursor: pointer;
            border: 2px solid transparent;
        }
        .shape-opt.active { border-color: var(--accent); background: #DCE9F5; }
        
        /* --- â€œæˆ‘â€é¡µé¢çš„æ ·å¼ --- */
.me-section {
    background: white;
    border-radius: 20px;
    margin: 15px 0;
    padding: 5px 20px;
    box-shadow: 0 4px 15px rgba(127, 166, 200, 0.08);
}
.me-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 0;
    border-bottom: 1px solid #f0f0f0;
    cursor: pointer;
}
.me-item:last-child {
    border-bottom: none;
}
.me-item-title {
    font-size: 15px;
    font-weight: 500;
    display: flex;
    align-items: center;
    gap: 12px; /* å›¾æ ‡å’Œæ–‡å­—çš„é—´è· */
}
.me-item .arrow {
    color: #ccc;
}

    /* --- â€œæˆ‘â€çš„å­é¡µé¢é€šç”¨æ ·å¼ --- */
    .me-page {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background-color: #F2F6FC;
        z-index: 80; /* æ¯”èŠå¤©å®¤é«˜ï¼Œä½†å¯ä»¥è¢«å…¶ä»–æ¨¡æ€æ¡†è¦†ç›– */
        display: none;
        flex-direction: column;
        animation: slideUp 0.3s ease;
    }
    .me-page-content {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
    }
    
    /* --- çºªå¿µæ—¥åˆ—è¡¨é¡¹æ ·å¼ --- */
    .anniversary-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px 5px;
        border-bottom: 1px solid #f5f5f5;
    }
     .anniversary-item:last-child { border-bottom: none; }
    .anniversary-info span { display: block; }
    .anniversary-info .name { font-size: 14px; font-weight: bold; color: #333; }
    .anniversary-info .date { font-size: 12px; color: #888; }
    
    .delete-btn {
        background: #FFEEEE; color: #F56C6C;
        border: none; border-radius: 50%;
        width: 30px; height: 30px;
        cursor: pointer;
        font-weight: bold;
    }
    
    /* --- é’±åŒ…è®°å½•æ ·å¼ --- */
    .bill-item {
        display: flex; justify-content: space-between; align-items: center;
        background: white; padding: 15px; border-radius: 12px; margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
    }
    .bill-info { font-size: 14px; color: #333; }
    .bill-time { font-size: 12px; color: #999; margin-top: 4px; }
    .bill-amount { font-weight: bold; font-size: 16px; }
    .bill-amount.plus { color: #67C23A; } /* ç»¿è‰²åŠ é’± */
    .bill-amount.minus { color: #F56C6C; } /* çº¢è‰²æ‰£é’± */

    /* --- è¡¨æƒ…åŒ…æ ¼å­æ ·å¼ --- */
    .sticker-item {
        width: 100%; aspect-ratio: 1; /* æ­£æ–¹å½¢ */
        background-color: #fff;
        border-radius: 12px;
        background-size: cover; background-position: center;
        cursor: pointer;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        position: relative;
    }
    .sticker-delete {
        position: absolute; top: -5px; right: -5px;
        width: 20px; height: 20px; background: #ff4d4f; color: white;
        border-radius: 50%; text-align: center; line-height: 20px; font-size: 12px;
    }
    
    /* --- èŠå¤©æ¶ˆæ¯é‡Œçš„å›¾ç‰‡æ ·å¼ (é‡è¦) --- */
    .msg-bubble img {
        max-width: 100%;
        border-radius: 8px;
        display: block;
    }
    
    /* --- æµ·é¾Ÿæ±¤æ ·å¼ --- */
    .soup-player-tag {
        padding: 8px 15px;
        background: rgba(0,0,0,0.3);
        border: 1px solid #555;
        border-radius: 20px;
        font-size: 12px;
        cursor: pointer;
        transition: 0.2s;
    }
    .soup-player-tag.selected {
        background: #E67E22;
        border-color: #E67E22;
        color: white;
        font-weight: bold;
    }
    
    /* æ¸¸æˆæ°”æ³¡ç¨å¾®ä¸åŒï¼ŒåŒºåˆ†äºæ™®é€šèŠå¤© */
    .soup-bubble {
        padding: 10px 14px;
        border-radius: 12px;
        font-size: 14px;
        max-width: 80%;
        line-height: 1.5;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .soup-dm { background: #2C3E50; color: #E67E22; border: 1px solid #E67E22; align-self: flex-start; }
    .soup-user { background: #E67E22; color: white; align-self: flex-end; }
    .soup-teammate { background: #34495E; color: #AED6F1; align-self: flex-start; }
    
    /* --- èŠå¤©å®¤å¤´åƒä¸æ—¶é—´æˆ³æ ·å¼ --- */
    .msg-row {
        align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
    }
    
    /* å¤´åƒå®¹å™¨ (åŒ…å«å›¾ç‰‡å’Œæ—¶é—´) */
    .msg-avatar-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        margin: 0 8px;
        flex-shrink: 0;
    }
    
  /* --- ç¼©å°çš„èŠå¤©å¸ƒå±€ (80% size) - ä¿®å¤ç‰ˆ --- */
    
    /* 1. ä¿®å¤å¤´åƒæ˜¾ç¤º */
    .msg-avatar-img {
        width: 32px; height: 32px; /* ä¿æŒç¼©å° */
        border-radius: 10px;
        margin-bottom: 2px;
        
        /* æ ¸å¿ƒä¿®å¤ä»£ç ï¼šå¼ºåˆ¶å›¾ç‰‡å¡«æ»¡ */
        background-size: cover !important;
        background-position: center !important;
        background-color: #e0e0e0; /* ç°è‰²åº•è‰²ï¼Œé˜²å›¾ç‰‡åŠ è½½å¤±è´¥ */
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .msg-timestamp {
        font-size: 9px;
        margin-top: 2px;
        transform: scale(0.85);
        opacity: 0.6;
    }

    /* 2. ä¿®å¤æ°”æ³¡åŸºç¡€æ ·å¼ */
    .msg-bubble {
        max-width: 75%;
        padding: 8px 12px;
        font-size: 13px !important;
        line-height: 1.4;
        /* æ³¨æ„ï¼šè¿™é‡Œåˆ æ‰äº† border-radiusï¼Œé˜²æ­¢è¦†ç›–ç”¨æˆ·çš„é€‰æ‹© */
    }

    /* 3. å¼ºåˆ¶ç”Ÿæ•ˆçš„æ°”æ³¡å½¢çŠ¶ (åŠ äº† !important) */
    .bubble-round { border-radius: 20px !important; }  /* åœ†æ»šæ»š */
    .bubble-sharp { border-radius: 2px !important; }   /* å°å°–è§’ */
    .bubble-default { border-radius: 10px !important; } /* é»˜è®¤ */

    /* è°ƒæ•´å·¦å³é—´è· */
    .msg-row.left .msg-bubble { margin-left: 6px; margin-top: 2px; }
    .msg-row.right .msg-bubble { margin-right: 6px; margin-top: 2px; }

    /* --- é€æ˜æ°”æ³¡æ¨¡å¼ (ç”¨äºå›¾ç‰‡/è½¬è´¦) --- */
    .bubble-transparent {
        background-color: transparent !important;
        box-shadow: none !important;
        padding: 0 !important;
        border: none !important;
    }
    .bubble-transparent img {
        display: block;
        border-radius: 8px;
        max-width: 140px !important; 
    }
    
    /* --- å¤šåŠŸèƒ½é¢æ¿æ ·å¼ --- */
    .panel-btn {
        display: flex; flex-direction: column; align-items: center;
        cursor: pointer; font-size: 12px; color: #666;
    }
    
    /* --- åŠŸèƒ½é¢æ¿å›¾æ ‡ç¾åŒ– --- */
    .panel-btn .p-icon {
        width: 44px; height: 44px; 
        background: white;
        border-radius: 14px; 
        display: flex; justify-content: center; align-items: center;
        margin-bottom: 6px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.03);
        transition: transform 0.1s;
        color: #5A6A7E;
    }
    .panel-btn:nth-child(1) .p-icon { color: #FFC107; background: #FFFDF5; }
    .panel-btn:nth-child(2) .p-icon { color: #FA9D3B; background: #FFF8F0; }
    .panel-btn:nth-child(3) .p-icon { color: #F56C6C; background: #FFF5F5; }
    .panel-btn:nth-child(4) .p-icon { color: #409EFF; background: #F0F7FF; }
    
    /* --- æ–°ç‰ˆè½¬è´¦å¡ç‰‡æ ·å¼ --- */
    .transfer-card {
        background-color: #FA9D3B;
        width: 200px;
        border-radius: 12px;
        overflow: hidden;
        color: white;
        position: relative;
        box-shadow: 0 2px 8px rgba(250, 157, 59, 0.3);
    }
    .transfer-top {
        padding: 12px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .transfer-icon-circle {
        width: 36px; height: 36px;
        border-radius: 50%;
        border: 2px solid white;
        display: flex; justify-content: center; align-items: center;
    }
    .transfer-info { display: flex; flex-direction: column; }
    .transfer-amount { font-size: 15px; font-weight: bold; }
    .transfer-desc { font-size: 11px; opacity: 0.9; }
    .transfer-bottom {
        background-color: rgba(255,255,255,0.15);
        padding: 6px 12px;
        font-size: 10px;
        color: rgba(255,255,255,0.9);
    }
    
    /* --- ğŸµ éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ --- */
    
    /* æ’­æ”¾å™¨æ¨¡æ€æ¡† (å±…ä¸­æ‚¬æµ®) */
    #music-player-modal {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0, 0, 0, 0.85); /* æ·±è‰²æ²‰æµ¸èƒŒæ™¯ */
        backdrop-filter: blur(10px);
        z-index: 150;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        color: white;
        animation: fadeIn 0.3s ease;
    }

    /* é¡¶éƒ¨æ­ŒååŒº */
    .music-info-top {
        text-align: center;
        margin-bottom: 40px;
    }
    .music-title { font-size: 22px; font-weight: bold; margin-bottom: 5px; }
    .music-artist { font-size: 14px; color: #aaa; }

    /* é»‘èƒ¶å”±ç‰‡åŒº */
    .vinyl-wrapper {
        width: 280px; height: 280px;
        border-radius: 50%;
        background: #1a1a1a;
        background-image: radial-gradient(circle, #111 30%, #333 31%, #111 32%, #333 60%, #111 61%);
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        display: flex; justify-content: center; align-items: center;
        position: relative;
        border: 4px solid #333;
    }
    /* å”±ç‰‡å°é¢ */
    .vinyl-cover {
        width: 180px; height: 180px;
        border-radius: 50%;
        background-size: cover; background-position: center;
        border: 5px solid #111;
    }
    /* æ—‹è½¬åŠ¨ç”» */
    .rotating { animation: rotate 20s linear infinite; }
    .paused { animation-play-state: paused; }
    
    @keyframes rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

    /* æ’­æ”¾æ§åˆ¶æ  */
    .player-controls {
        margin-top: 50px;
        display: flex; align-items: center; gap: 30px;
    }
    .ctrl-btn {
        cursor: pointer; color: white; transition: transform 0.1s;
        display: flex; justify-content: center; align-items: center;
    }
    .ctrl-btn:active { transform: scale(0.9); color: var(--accent); }
    .ctrl-btn-big {
        width: 60px; height: 60px; border-radius: 50%;
        background: white; color: #333;
    }

    /* æ­Œå•åˆ—è¡¨æ¨¡æ€æ¡† */
    #music-list-modal {
        position: fixed; bottom: 0; left: 0; width: 100%; height: 60%;
        background: white;
        border-radius: 20px 20px 0 0;
        z-index: 160;
        display: none;
        flex-direction: column;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
        animation: slideUp 0.3s ease;
    }
    .music-list-item {
        padding: 15px 20px;
        border-bottom: 1px solid #f5f5f5;
        display: flex; justify-content: space-between; align-items: center;
    }
    .music-list-item.playing { color: var(--accent); font-weight: bold; }
    
    /* --- é•¿æŒ‰èœå•æ ·å¼ --- */
    #msg-context-menu {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 200;
        display: none;
        justify-content: center;
        align-items: center;
        animation: fadeIn 0.2s;
    }
    .menu-content {
        background: white;
        border-radius: 12px;
        width: 70%;
        overflow: hidden;
        box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }
    .menu-item {
        padding: 15px;
        text-align: center;
        border-bottom: 1px solid #eee;
        font-size: 16px;
        color: #333;
        cursor: pointer;
    }
    .menu-item:last-child { border-bottom: none; }
    .menu-item:active { background: #f5f5f5; }
    .menu-item.danger { color: #ff4d4f; }

    /* --- æŸ¥çœ‹æ›´å¤šå†å²è®°å½•æŒ‰é’® --- */
    .load-more-btn {
        text-align: center;
        font-size: 12px;
        color: #7FA6C8;
        padding: 10px 0;
        cursor: pointer;
    }
    
    /* --- INS é£åŠ å·é¢æ¿æ ·å¼ --- */
    
    /* é¢æ¿å®¹å™¨ï¼šå¹³æ—¶è—åœ¨å±å¹•æœ€åº•ä¸‹ */
    #chat-action-panel {
        position: absolute; 
        bottom: 0; left: 0; right: 0;
        background: white;
        border-radius: 30px 30px 0 0; /* åªæœ‰ä¸Šé¢æ˜¯åœ†è§’ */
        box-shadow: 0 -10px 40px rgba(0,0,0,0.08); /* å”¯ç¾çš„å¤§é˜´å½± */
        padding: 25px 20px 40px 20px; /* å¢åŠ åº•éƒ¨ç•™ç™½ */
        z-index: 100;
        transform: translateY(110%); /* é»˜è®¤å‘ä¸‹è—èµ·æ¥ */
        transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1); /* é¡ºæ»‘çš„åŠ¨ç”»æ›²çº¿ */
        display: block !important; /* å¼ºåˆ¶æ˜¾ç¤ºï¼Œé€šè¿‡ transform æ§åˆ¶å¼€å…³ */
    }

    /* æ¿€æ´»çŠ¶æ€ï¼šæ»‘ä¸Šæ¥ */
    #chat-action-panel.active {
        transform: translateY(0);
    }

    /* é¡¶éƒ¨çš„å°æ¨ªæ¡ (è£…é¥°ç”¨ï¼ŒåƒiPhoneåº•éƒ¨æŠ½å±‰) */
    .panel-handle {
        width: 40px; height: 5px;
        background: #E0E0E0;
        border-radius: 10px;
        margin: 0 auto 25px auto; /* å±…ä¸­ */
    }

    /* åŠŸèƒ½å›¾æ ‡ç½‘æ ¼ */
    .ins-grid {
        display: flex;
        justify-content: space-between;
        padding: 0 10px;
        margin-bottom: 20px;
    }

    /* å•ä¸ªå›¾æ ‡æŒ‰é’® */
    .ins-btn {
        display: flex; flex-direction: column; align-items: center;
        gap: 8px; cursor: pointer; transition: transform 0.1s;
    }
    .ins-btn:active { transform: scale(0.95); }

    /* å›¾æ ‡åœ†åœˆèƒŒæ™¯ */
    .ins-icon-circle {
        width: 56px; height: 56px;
        border-radius: 20px; /* æ–¹åœ†å½¢ */
        display: flex; justify-content: center; align-items: center;
        font-size: 24px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.06);
        color: white;
    }

    /* ä¸åŒåŠŸèƒ½çš„é¢œè‰² */
    .bg-yellow { background: linear-gradient(135deg, #FFD54F, #FFC107); box-shadow: 0 8px 20px rgba(255, 193, 7, 0.25); }
    .bg-green  { background: linear-gradient(135deg, #81C784, #66BB6A); box-shadow: 0 8px 20px rgba(102, 187, 106, 0.25); }
    .bg-pink   { background: linear-gradient(135deg, #FF8A65, #FF7043); box-shadow: 0 8px 20px rgba(255, 112, 67, 0.25); }
    .bg-blue   { background: linear-gradient(135deg, #64B5F6, #42A5F5); box-shadow: 0 8px 20px rgba(66, 165, 245, 0.25); }
    .bg-purple { background: linear-gradient(135deg, #BA68C8, #AB47BC); box-shadow: 0 8px 20px rgba(171, 71, 188, 0.25); }

    .ins-label { font-size: 12px; color: #666; font-weight: 500; }

    /* å†…å®¹å±•ç¤ºåŒº (è¡¨æƒ…åŒ…ç½‘æ ¼ç­‰) */
    #panel-content-area {
        background: #F7F9FC; /* æµ…ç°è‰²åº•ï¼ŒåŒºåˆ†å±‚æ¬¡ */
        border-radius: 20px;
        padding: 15px;
        max-height: 200px;
        overflow-y: auto;
        margin-top: 10px;
        display: none; /* é»˜è®¤éšè—ï¼Œç‚¹å‡»å›¾æ ‡æ‰æ˜¾ç¤º */
    }
    
    /* --- ä¿¡æ¯å±•ç¤ºå¼¹çª— (å·çœ‹éšç§ä¸“ç”¨) --- */
    #info-modal {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 300;
        display: none; justify-content: center; align-items: center;
        animation: fadeIn 0.3s;
    }
    .info-card {
        background: white; width: 80%; max-height: 70%;
        border-radius: 24px; padding: 25px;
        overflow-y: auto; position: relative;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        display: flex; flex-direction: column;
    }
    .info-header {
        font-size: 18px; font-weight: bold; margin-bottom: 15px;
        display: flex; align-items: center; gap: 10px; color: #333;
    }
    .info-content {
        font-size: 14px; line-height: 1.6; color: #555; white-space: pre-wrap;
    }
    /* åŠ è½½åŠ¨ç”» */
    .loading-dots::after {
        content: ' .'; animation: dots 1.5s infinite;
    }
    @keyframes dots { 0%{content:'.'} 33%{content:'..'} 66%{content:'...'} }
    </style>
</head>
<body>
    <!-- èƒŒæ™¯å£çº¸å±‚ (ç‚¹å‡»æ›´æ¢) -->
    <div id="wallpaper-layer" onclick="document.getElementById('bg-upload').click()" title="ç‚¹å‡»æ›´æ¢å£çº¸"></div>
    <input type="file" id="bg-upload" class="hidden-input" accept="image/*">

    <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
    <div id="status-bar">
        <span id="status-time">00:00</span>
        <div style="display: flex; align-items: center; gap: 5px;">
            <span id="battery-percent">--%</span>
            <div class="battery-icon">
                <div class="battery-level" id="battery-fill"></div>
            </div>
        </div>
    </div>

    <!-- å¤´åƒåŒºåŸŸ (ç‚¹å‡»æ›´æ¢) -->
    <div id="avatar-box" onclick="document.getElementById('avatar-upload').click()">
        <span>ç‚¹æ­¤ä¸Šä¼ </span>
    </div>
    <input type="file" id="avatar-upload" class="hidden-input" accept="image/*">

    <!-- ä¸»å±å¹•æ—¶é—´ -->
    <div id="main-clock">00:00</div>

    <!-- åº”ç”¨å›¾æ ‡åŒºåŸŸ -->
    <div id="app-grid">
        <!-- API è®¾ç½®åº”ç”¨å›¾æ ‡ -->
        <div class="app-icon" onclick="openApp('api-settings')">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
            <div class="app-name">APIè®¾ç½®</div>
        </div>
        
        <!-- Chat åº”ç”¨å›¾æ ‡ -->
        <div class="app-icon" onclick="openChatApp()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
            </svg>
            <div class="app-name">Chat</div>
        </div>
    </div>

    <!-- === API è®¾ç½®åº”ç”¨ç•Œé¢ (æ–°ç‰ˆ UI) === -->
    <div id="api-settings" class="modal">
        <div class="api-header">
            <div class="api-back-btn" onclick="closeApp('api-settings')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>API è®¾ç½®</h2>
        </div>

        <div class="api-content-scroll">
            <div class="settings-card">
                <div class="form-group">
                    <div class="setting-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                        API åœ°å€ (Base URL)
                    </div>
                    <input type="text" id="api-url" class="cute-input" placeholder="https://api.openai.com/v1">
                    <div class="helper-text">æ”¯æŒ OpenAI æ ¼å¼æ¥å£ã€‚å¦‚ä½¿ç”¨ç¬¬ä¸‰æ–¹ä»£ç†ï¼Œè¯·ç¡®ä¿å¡«å†™å®Œæ•´çš„ /v1 åç¼€ã€‚</div>
                </div>

                <div class="form-group">
                    <div class="setting-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2"><path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path></svg>
                        API å¯†é’¥ (Key)
                    </div>
                    <input type="password" id="api-key" class="cute-input" placeholder="sk-........................">
                </div>

                <div class="form-group">
                    <div class="setting-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>
                        æ¨¡å‹é€‰æ‹©
                    </div>
                    <div class="model-row">
                        <div class="model-select-wrapper">
                            <select id="model-select" class="cute-input" style="appearance: none; background-color: #F5F7FA;">
                                <option value="" disabled selected>è¯·å…ˆæ‹‰å–åˆ—è¡¨</option>
                            </select>
                        </div>
                        <button class="btn-refresh" onclick="fetchModels()">æ‹‰å–æ¨¡å‹</button>
                    </div>
                </div>

                <div class="form-group">
                    <div class="setting-label">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#7FA6C8" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 0 0-5 0v11.26a4.5 4.5 0 1 0 5 0z"></path></svg>
                        æ¸©åº¦å‚æ•° (Temperature)
                    </div>
                    <div style="display: flex; align-items: center; justify-content: space-between;">
                        <div class="helper-text" style="margin-top:0; max-width: 70%;">
                            æ•°å€¼è¶Šå¤§è¶Šæœ‰åˆ›æ„ (0 - 2.0)<br>
                            <span style="color: #bbb;">å»ºè®®å€¼: 0.7</span>
                        </div>
                        <div class="temp-wrapper">
                            <input type="number" id="api-temp" class="temp-input-clean" value="0.7" min="0" max="2.0" step="0.1">
                        </div>
                    </div>
                </div>
            </div>
            <button class="btn-save" onclick="saveSettings()">ä¿å­˜æ‰€æœ‰é…ç½®</button>
            <div style="height: 50px;"></div>
        </div>
    </div>
    
    <!-- === Chat åº”ç”¨ç•Œé¢ === -->
    <div id="chat-app" class="modal">
        <div class="chat-header-bar">
            <div class="chat-title" id="chat-page-title">Chats</div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div id="add-contact-btn" onclick="showCreatePage()" title="æ·»åŠ è”ç³»äºº">
                    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M2 12C2 6.48 6.48 2 12 2s10 4.48 10 10v.5c0 1.38-1.12 2.5-2.5 2.5S17 13.88 17 12.5V12a5 5 0 0 0-5-5 5 5 0 0 0-5 5v6c0 3.87 3.13 7 7 7s7-3.13 7-7"></path>
                        <path d="M12 12v.01"></path>
                    </svg>
                </div>
                <div class="close-btn" onclick="closeApp('chat-app')" style="font-size: 20px; padding:0;">Ã—</div>
            </div>
        </div>

        <div id="tab-chats" class="chat-content-area"></div>
        <div id="tab-contacts" class="chat-content-area" style="display: none;">
            <div id="contact-list"></div>
        </div>

    <!-- â–¼â–¼â–¼â–¼â–¼ åœ¨è¿™é‡Œæ·»åŠ æ–°çš„é¡µé¢å®¹å™¨ â–¼â–¼â–¼â–¼â–¼ -->
    <div id="tab-me" class="chat-content-area" style="display: none; padding-top: 20px;">

<div class="me-section">
    <!-- â–¼â–¼â–¼ ä¿®æ”¹ onclick â–¼â–¼â–¼ -->
    <div class="me-item" onclick="openMeSubPage('me-persona-page')">
        <div class="me-item-title">
            <span>ğŸ­</span>
            <span>æˆ‘çš„äººè®¾</span>
        </div>
        <div class="arrow">&gt;</div>
    </div>
     <!-- â–¼â–¼â–¼ ä¿®æ”¹ onclick â–¼â–¼â–¼ -->
    <div class="me-item" onclick="openMeSubPage('me-anniversary-page')">
        <div class="me-item-title">
            <span>ğŸ’–</span>
            <span>æˆ‘ä»¬çš„çºªå¿µæ—¥</span>
        </div>
        <div class="arrow">&gt;</div>
    </div>
</div>

<div class="me-section">
            <!-- ä¿®æ”¹é’±åŒ…å…¥å£ -->
            <div class="me-item" onclick="openMeSubPage('me-wallet-page')">
                <div class="me-item-title">
                    <span>ğŸ’°</span>
                    <span>æˆ‘çš„é’±åŒ…</span>
                </div>
                 <div class="arrow">&gt;</div>
            </div>
            <!-- ä¿®æ”¹è¡¨æƒ…åŒ…å…¥å£ -->
            <div class="me-item" onclick="openMeSubPage('me-sticker-page')">
                <div class="me-item-title">
                    <span>ğŸ˜‚</span>
                    <span>è¡¨æƒ…åŒ…åº“</span>
                </div>
                 <div class="arrow">&gt;</div>
            </div>
        </div>

    <div class="me-section">
         <div class="me-item" onclick="openSoupLobby()">
            <div class="me-item-title">
                <span>ğŸ¢</span>
                <span>æµ·é¾Ÿæ±¤æ¸¸æˆ</span>
            </div>
             <div class="arrow">&gt;</div>
        </div>
    </div>

</div>
    <!-- â–²â–²â–²â–²â–² æ·»åŠ å®Œæ¯• â–²â–²â–²â–²â–² -->
    
    <!-- â–¼â–¼â–¼â–¼â–¼ ä»è¿™é‡Œå¼€å§‹æ·»åŠ  â–¼â–¼â–¼â–¼â–¼ -->

    <!-- === â€œæˆ‘çš„äººè®¾â€åˆ—è¡¨é¡µé¢ === -->
    <div id="me-persona-page" class="me-page">
        <div class="api-header">
            <div class="api-back-btn" onclick="closeMeSubPage('me-persona-page')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>äººè®¾åº“</h2>
            <div style="position: absolute; right: 20px; color: var(--accent); font-weight: bold; cursor: pointer;" onclick="openPersonaCreate()">
                æ–°å»º
            </div>
        </div>
        <div class="me-page-content">
            <div class="helper-text" style="margin-bottom: 10px;">ç‚¹å‡»é€‰ä¸­å½“å‰è¦ä½¿ç”¨çš„äººè®¾ï¼š</div>
            <div id="persona-list-container">
                <!-- äººè®¾åˆ—è¡¨ä¼šåœ¨è¿™é‡Œç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- === æ–°å»º/ç¼–è¾‘äººè®¾é¡µé¢ (è¦†ç›–å±‚) === -->
    <div id="persona-create-page" class="me-page" style="z-index: 85;">
        <div class="api-header">
            <div class="api-back-btn" onclick="document.getElementById('persona-create-page').style.display='none'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>ç¼–è¾‘äººè®¾</h2>
        </div>
        <div class="me-page-content">
            <div class="create-card">
                <!-- äººè®¾å¤´åƒä¸Šä¼  -->
                <div class="avatar-uploader" id="persona-avatar-preview" onclick="document.getElementById('persona-file-input').click()">
                    <div style="text-align:center;">
                         <div style="font-size: 24px;">ğŸ“·</div>
                        <div style="margin-top:4px;">äººè®¾å¤´åƒ</div>
                    </div>
                </div>
                <input type="file" id="persona-file-input" class="hidden-input" accept="image/*">
                
                <div class="input-row">
                    <div class="input-label">äººè®¾åç§° (å¦‚ï¼šæ’’å¨‡æ€ª)</div>
                    <input type="text" id="persona-name-input" class="clean-input">
                </div>

                <div class="input-row">
                    <div class="input-label">äººè®¾è¯¦æƒ… (AIä¼šæ ¹æ®è¿™ä¸ªè®¤è¯†ä½ )</div>
                    <textarea id="persona-desc-input" class="clean-input" rows="6" placeholder="æˆ‘æ˜¯è°ï¼Ÿæˆ‘å«ä»€ä¹ˆï¼Ÿæˆ‘ç°åœ¨çš„çŠ¶æ€æ˜¯ï¼Ÿ"></textarea>
                </div>

                <button class="btn-save" onclick="saveNewPersona()">ä¿å­˜å¹¶ä½¿ç”¨</button>
            </div>
        </div>
    </div>

    <!-- === â€œæˆ‘ä»¬çš„çºªå¿µæ—¥â€è®¾ç½®é¡µé¢ === -->
    <div id="me-anniversary-page" class="me-page">
        <div class="api-header">
            <div class="api-back-btn" onclick="closeMeSubPage('me-anniversary-page')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>æˆ‘ä»¬çš„çºªå¿µæ—¥</h2>
        </div>
        <div class="me-page-content">
            <!-- å·²æœ‰çºªå¿µæ—¥åˆ—è¡¨ -->
            <div id="anniversary-list" class="settings-card">
                <!-- çºªå¿µæ—¥ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
                <div class="helper-text" style="text-align: center;">è¿˜æ²¡æœ‰çºªå¿µæ—¥ï¼Œå¿«æ·»åŠ ä¸€ä¸ªå§ï¼</div>
            </div>

            <!-- æ·»åŠ æ–°çºªå¿µæ—¥è¡¨å• -->
            
            <div class="settings-card">
                <div class="setting-label">æ·»åŠ æ–°çš„çºªå¿µæ—¥</div>
                
                <!-- â–¼â–¼â–¼ æ–°å¢ï¼šè§’è‰²é€‰æ‹©å™¨ â–¼â–¼â–¼ -->
                <div class="input-row" style="margin-bottom: 15px;">
                    <div class="input-label">å…³è”è§’è‰²</div>
                    <select id="anniversary-role-select" class="clean-input" style="background: #F7F9FC;">
                        <option value="all">ä¸ç»‘å®š (æ‰€æœ‰äººéƒ½çŸ¥é“)</option>
                    </select>
                </div>
                <!-- â–²â–²â–² æ–°å¢ç»“æŸ â–²â–²â–² -->

                <div class="input-row" style="margin-bottom: 15px;">
                    <input type="text" id="anniversary-name" class="clean-input" placeholder="çºªå¿µæ—¥åç§° (ä¾‹å¦‚ï¼šç¬¬ä¸€æ¬¡èŠå¤©)">
                </div>
                <div class="input-row">
                    <input type="date" id="anniversary-date" class="clean-input">
                </div>
                <button class="btn" onclick="addAnniversary()" style="margin-top: 20px;">æ·»åŠ </button>
            </div>
        </div>
    </div>

    <!-- â–²â–²â–²â–²â–² æ·»åŠ åˆ°è¿™é‡Œç»“æŸ â–²â–²â–²â–²â–² -->
    
    <!-- === â€œæˆ‘çš„é’±åŒ…â€é¡µé¢ === -->
    <div id="me-wallet-page" class="me-page">
        <div class="api-header" style="background: #5B7C99; color: white;">
            <div class="api-back-btn" onclick="closeMeSubPage('me-wallet-page')" style="color: white;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2 style="color: white;">æˆ‘çš„å°é‡‘åº“</h2>
        </div>
        <div class="me-page-content" style="padding: 0;">
            <!-- ä½™é¢å¡ç‰‡ -->
            <div style="background: #5B7C99; color: white; padding: 20px 30px 40px 30px; border-radius: 0 0 30px 30px; text-align: center; box-shadow: 0 10px 20px rgba(91, 124, 153, 0.3);">
                <div style="font-size: 14px; opacity: 0.8;">å½“å‰ä½™é¢ (è™šæ‹Ÿå¸)</div>
                <div style="font-size: 48px; font-weight: bold; margin: 10px 0;" id="wallet-balance">0</div>
                <div style="display: flex; gap: 15px; justify-content: center; margin-top: 20px;">
                    <button class="btn" style="background: rgba(255,255,255,0.2); width: auto; padding: 8px 20px; backdrop-filter: blur(5px);" onclick="addBalance(100)">+ ç­¾åˆ°é¢†å¸</button>
                    <button class="btn" style="background: rgba(255,255,255,0.2); width: auto; padding: 8px 20px; backdrop-filter: blur(5px);" onclick="resetBalance()">â†º é‡ç½®</button>
                </div>
            </div>
            
            <!-- äº¤æ˜“è®°å½• -->
            <div style="padding: 20px;">
                <div style="font-weight: bold; color: #555; margin-bottom: 15px;">è¿‘æœŸè´¦å•</div>
                <div id="wallet-history">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- === â€œè¡¨æƒ…åŒ…åº“â€é¡µé¢ === -->
    <div id="me-sticker-page" class="me-page">
        <div class="api-header">
            <div class="api-back-btn" onclick="closeMeSubPage('me-sticker-page')">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>è¡¨æƒ…åŒ…ä»“åº“</h2>
            
            <!-- â–¼â–¼â–¼ æ–°å¢ï¼šä¸Šä¼ ç›®æ ‡é€‰æ‹© â–¼â–¼â–¼ -->
            <select id="sticker-role-select" class="clean-input" style="width: 100px; padding: 5px; margin-right: 10px; font-size: 12px;">
                <option value="all">é€šç”¨</option>
                <!-- è§’è‰²åˆ—è¡¨ä¼šåŠ¨æ€åŠ è½½åˆ°è¿™é‡Œ -->
            </select>
            
            <!-- æ·»åŠ æŒ‰é’® -->
            <div style="color: var(--accent); font-weight: bold; cursor: pointer;" onclick="document.getElementById('sticker-upload').click()">
                + æ·»åŠ 
            </div>
            <input type="file" id="sticker-upload" class="hidden-input" accept="image/*" multiple>
        </div>
            
        <div class="me-page-content">
            <div class="helper-text" style="text-align: center; margin-bottom: 20px;">ç‚¹å‡»è¡¨æƒ…åŒ…å³å¯å‘é€ç»™å½“å‰èŠå¤©çš„è§’è‰²</div>
            <div id="sticker-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                <!-- è¡¨æƒ…åŒ…å›¾ç‰‡ä¼šåœ¨è¿™é‡Œ -->
            </div>
        </div>
    </div>
    
    <!-- === æµ·é¾Ÿæ±¤ï¼šç»„å±€å¤§å… === -->
    <div id="soup-lobby-page" class="me-page">
        <div class="api-header" style="background: #2C3E50; color: white;">
            <div class="api-back-btn" onclick="closeMeSubPage('soup-lobby-page')" style="color: white;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2 style="color: white;">æµ·é¾Ÿæ±¤ç»„å±€</h2>
        </div>
        <div class="me-page-content" style="background: #34495E; color: white;">
            
            <!-- â–¼â–¼â–¼ ä¿®æ”¹åçš„å‰§æœ¬ç”Ÿæˆå¡ç‰‡ â–¼â–¼â–¼ -->
            <div class="settings-card" style="background: rgba(255,255,255,0.1); color: white; border: none;">
                <div class="setting-label" style="color: #AAB7B8;">1. AI ç°ç…®æµ·é¾Ÿæ±¤</div>
                
                <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                    <input type="text" id="soup-topic-input" class="clean-input" placeholder="è¾“å…¥å…³é”®è¯(å¦‚:ææ€–/æ ¡å›­/ç§‘å¹»)..." style="background: rgba(0,0,0,0.2); color: white; border: 1px solid #555;">
                    <button class="btn" onclick="generateSoupScript()" style="width: auto; white-space: nowrap; background: #E67E22;">ç”Ÿæˆ</button>
                </div>

                <!-- åŠ è½½åŠ¨ç”»/æç¤º -->
                <div id="soup-loading" style="display: none; color: #E67E22; font-size: 12px; text-align: center; margin-bottom: 10px;">
                    AI æ­£åœ¨ç†¬æ±¤ä¸­ï¼Œè¯·ç¨å€™... ğŸ²
                </div>

                <div id="soup-script-preview" style="font-size: 13px; color: #ccc; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; line-height: 1.6; min-height: 60px;">
                    <span style="color: #777;">(ç‚¹å‡»ç”ŸæˆæŒ‰é’®ï¼Œè·å–ä¸€ä¸ªå…¨æ–°çš„æ•…äº‹)</span>
                </div>
            </div>
            <!-- â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–² -->

            <div class="settings-card" style="background: rgba(255,255,255,0.1); color: white; border: none;">
                <div class="setting-label" style="color: #AAB7B8;">2. è°æ˜¯ä¸»æŒäºº (DM)?</div>
                <select id="soup-dm-select" class="clean-input" style="background: rgba(0,0,0,0.2); color: white; border: 1px solid #555;">
                    <!-- è§’è‰²åˆ—è¡¨ -->
                </select>
                <div class="helper-text" style="color: #777;">ä¸»æŒäººçŸ¥é“çœŸç›¸ï¼Œè´Ÿè´£å›ç­”â€œæ˜¯â€æˆ–â€œå¦â€ã€‚</div>
            </div>

            <div class="settings-card" style="background: rgba(255,255,255,0.1); color: white; border: none;">
                <div class="setting-label" style="color: #AAB7B8;">3. é‚€è¯·è°ä¸€èµ·ç©? (å¤šé€‰)</div>
                <div id="soup-player-list" style="display: flex; flex-wrap: wrap; gap: 10px;">
                    <!-- é˜Ÿå‹é€‰æ‹©åˆ—è¡¨ -->
                </div>
            </div>

            <button class="btn-save" onclick="startSoupGame()" style="background: #E67E22; margin-top: 20px;">å¼€å§‹å‘æ±¤</button>
        </div>
    </div>

    <!-- === æµ·é¾Ÿæ±¤ï¼šæ¸¸æˆæˆ¿é—´ === -->
    <div id="soup-game-room" class="me-page" style="background: #2C3E50; z-index: 90;">
        <!-- é¡¶éƒ¨ -->
        <div class="room-header" style="background: #34495E; border-bottom: 1px solid #444;">
            <div onclick="quitSoupGame()" style="padding: 10px; cursor: pointer; color: white;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <div class="room-info" style="color: white;">
                <div class="room-name">æµ·é¾Ÿæ±¤è¿›è¡Œä¸­</div>
                <div class="room-status" style="color: #E67E22;" id="soup-status">ä¸»æŒäººå‡†å¤‡ä¸­...</div>
            </div>
            <div onclick="endSoupGameAndSave()" style="padding: 10px; cursor: pointer; color: #E67E22; font-size: 12px; font-weight: bold;">
                ç»“æŸå¹¶å­˜æ¡£
            </div>
        </div>

        <!-- æ±¤é¢å±•ç¤ºåŒº -->
        <div style="padding: 15px; background: rgba(0,0,0,0.2); margin: 10px; border-radius: 10px; color: #ddd; font-size: 13px; line-height: 1.5;">
            <span style="color: #E67E22; font-weight: bold;">æ±¤é¢ï¼š</span>
            <span id="current-soup-text">...</span>
        </div>

        <!-- æ¸¸æˆè®°å½• -->
        <div id="soup-chat-container" style="flex: 1; overflow-y: auto; padding: 10px 20px; display: flex; flex-direction: column; gap: 15px;">
            <!-- æ¶ˆæ¯æµ -->
        </div>

        <!-- åº•éƒ¨æ“ä½œæ  -->
        <div class="room-footer" style="background: #34495E; border-top: 1px solid #444;">
            <!-- é˜Ÿå‹æé—®æŒ‰é’® -->
            <div class="action-btn" style="width: auto; padding: 0 10px; border-radius: 15px; background: #E67E22; color: white; font-size: 12px; margin-right: 5px;" onclick="triggerTeammateAsk()">
                è®©é˜Ÿå‹çŒœ
            </div>
            
            <textarea id="soup-input" class="chat-input-box" rows="1" placeholder="æé—® (æ˜¯/å¦é¢˜ç›®)..." style="background: #2C3E50; color: white;"></textarea>
            
            <div class="action-btn btn-send" onclick="sendSoupUserMsg()" style="background: #E67E22;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </div>
        </div>
    </div>

        <div class="bottom-nav">
    <div class="nav-item active" onclick="switchChatTab('chats', this)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"></path></svg>
        <span class="nav-label">èŠå¤©</span>
    </div>
    <div class="nav-item" onclick="switchChatTab('contacts', this)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"></path></svg>
        <span class="nav-label">è”ç³»äºº</span>
    </div>
    <!-- â–¼â–¼â–¼â–¼â–¼ æ·»åŠ ä¸‹é¢è¿™ä¸ª DIV â–¼â–¼â–¼â–¼â–¼ -->
    <div class="nav-item" onclick="switchChatTab('me', this)">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm0 14.2c-2.5 0-4.71-1.28-6-3.22.03-1.99 4-3.08 6-3.08 1.99 0 5.97 1.09 6 3.08-1.29 1.94-3.5 3.22-6 3.22z"></path></svg>
        <span class="nav-label">æˆ‘</span>
    </div>
    <!-- â–²â–²â–²â–²â–² æ·»åŠ ä¸Šé¢è¿™ä¸ª DIV â–²â–²â–²â–²â–² -->
</div>

        <!-- === ç‹¬ç«‹çš„åˆ›å»ºè§’è‰²é¡µé¢ (é»˜è®¤éšè—) === -->
        <div id="create-role-page">
            <div class="create-header">
                <div class="back-icon" onclick="hideCreatePage()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                </div>
                <div>åˆ›å»ºæ–°è§’è‰²</div>
            </div>

            <div class="create-card">
                <div class="avatar-uploader" id="new-role-avatar" onclick="document.getElementById('role-file').click()">
                    <div style="text-align:center;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                        <div style="margin-top:4px;">ä¸Šä¼ å¤´åƒ</div>
                    </div>
                </div>
                <!-- è¡¥å›ä¸¢å¤±çš„ input -->
                <input type="file" id="role-file" class="hidden-input" accept="image/*">
                
                <div class="input-row">
                    <div class="input-label">è§’è‰²åç§°</div>
                    <input type="text" id="role-name" class="clean-input" placeholder="ä¾‹å¦‚ï¼šå°çŒ«å’ª">
                </div>

                <div class="input-row">
                    <div class="input-label">æ€§åˆ« / è®¾å®š</div>
                    <div class="gender-capsule" id="gender-select-box">
                        <div class="gender-opt active" onclick="selectGender(this, 'ç”·ç”Ÿ')">ç”·ç”Ÿ</div>
                        <div class="gender-opt" onclick="selectGender(this, 'å¥³ç”Ÿ')">å¥³ç”Ÿ</div>
                        <div class="gender-opt" onclick="selectGender(this, 'å® ç‰©')">å® ç‰©</div>
                    </div>
                </div>

                <div class="input-row">
                    <div class="input-label">äººè®¾ä¸æ€§æ ¼</div>
                    <textarea id="role-prompt" class="clean-input" rows="3" placeholder="TAæ˜¯ä»€ä¹ˆæ ·çš„æ€§æ ¼ï¼Ÿè¯´è¯æœ‰ä»€ä¹ˆå£ç™–ï¼Ÿ" style="resize: none;"></textarea>
                </div>

                <button class="create-btn-float" onclick="createNewRole()">ç¡®è®¤åˆ›å»º</button>
            </div>
        </div>
        
        <!-- === 5. èŠå¤©å®¤é¡µé¢ === -->
    <div id="chat-room-page">
        <!-- é¡¶éƒ¨ -->
        <div class="room-header">
            <div onclick="closeChatRoom()" style="padding: 10px; cursor: pointer;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <div class="room-info">
                <div class="room-name" id="current-chat-name">è§’è‰²å</div>
                <div class="room-status" id="typing-status">å¯¹æ–¹æ­£åœ¨è¾“å…¥...</div>
            </div>
            <!-- è®¾ç½®æŒ‰é’® (éé½¿è½®ï¼Œæ›´ä¼˜é›…çš„èœå•å›¾æ ‡) -->
            <div onclick="openChatSettings()" style="padding: 10px; cursor: pointer;">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#333" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="19" cy="12" r="1"></circle>
                    <circle cx="5" cy="12" r="1"></circle>
                </svg>
            </div>
        </div>

        <!-- æ¶ˆæ¯åˆ—è¡¨ -->
        <div id="message-container">
            <!-- æ¶ˆæ¯ä¼šåŠ¨æ€ç”Ÿæˆåœ¨è¿™é‡Œ -->
            <div class="msg-row left">
                <div class="msg-bubble bubble-default" style="background: white; color: #333;">
                    ä½ å¥½å‘€ï¼Œæˆ‘æ˜¯ä½ çš„ä¸“å± AI ä¼™ä¼´ã€‚
                </div>
            </div>
            <div class="msg-row right">
                <div class="msg-bubble bubble-default" style="background: #FFE6E6; color: #333;">
                    ä½ å¥½ï¼
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨è¾“å…¥æ  -->
        <!-- â–¼â–¼â–¼â–¼â–¼ æ’å…¥è¿™ä¸ªç¼ºå¤±çš„é¢æ¿ â–¼â–¼â–¼â–¼â–¼ -->
        <!-- â–¼â–¼â–¼â–¼â–¼ å¤šåŠŸèƒ½é¢æ¿ â–¼â–¼â–¼â–¼â–¼ -->
        
            
            <!-- â–¼â–¼â–¼ æ–°ç‰ˆ INS é£å¤šåŠŸèƒ½é¢æ¿ â–¼â–¼â–¼ -->
        <div id="chat-action-panel">
            <!-- é¡¶éƒ¨å°æ¨ªæ¡ -->
            <div class="panel-handle"></div>

            <!-- å›¾æ ‡æŒ‰é’®åŒº -->
            <div class="ins-grid">
                <!-- 1. è¡¨æƒ… -->
                <div class="ins-btn" onclick="switchPanelTab('sticker')">
                    <div class="ins-icon-circle bg-yellow">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                    </div>
                    <span class="ins-label">è¡¨æƒ…</span>
                </div>

                <!-- 2. è½¬è´¦ -->
                <div class="ins-btn" onclick="switchPanelTab('transfer')">
                    <div class="ins-icon-circle bg-green">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="5" width="20" height="14" rx="2"></rect><line x1="2" y1="10" x2="22" y2="10"></line></svg>
                    </div>
                    <span class="ins-label">è½¬è´¦</span>
                </div>

                <!-- 3. çŠ¶æ€ -->
                <div class="ins-btn" onclick="checkRoleStatus()">
                    <div class="ins-icon-circle bg-pink">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>
                    </div>
                    <span class="ins-label">è¯»å¿ƒ</span>
                </div>

                <!-- 4. æ–‡å­—å›¾ -->
                <div class="ins-btn" onclick="sendTextImg()">
                    <div class="ins-icon-circle bg-blue">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                    </div>
                    <span class="ins-label">ä¾¿ç­¾</span>
                </div>

                <!-- 5. ä¸€èµ·å¬ -->
                <div class="ins-btn" onclick="openMusicPlayer()">
                    <div class="ins-icon-circle bg-purple">
                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18V5l12-2v13"></path><circle cx="6" cy="18" r="3"></circle><circle cx="18" cy="16" r="3"></circle></svg>
                    </div>
                    <span class="ins-label">ä¸€èµ·å¬</span>
                </div>
            </div>

            <!-- å†…å®¹å±•ç¤ºåŒº (é»˜è®¤éšè—ï¼Œç‚¹äº†å›¾æ ‡æ‰å‡ºæ¥) -->
            <div id="panel-content-area">
                <div id="panel-sticker-grid" style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;"></div>
                
                <div id="panel-transfer-box" style="display: none; text-align: center; padding: 10px;">
                    <div style="margin-bottom:10px; color:#888; font-size:13px;">è¯·è¾“å…¥é‡‘é¢</div>
                    <input type="number" id="transfer-amount" class="cute-input" style="text-align: center; font-size: 20px; font-weight: bold; color: #333; margin-bottom: 15px;" placeholder="Â¥">
                    <div style="display: flex; gap: 10px;">
                        <button class="btn" onclick="doTransfer('to_ai')" style="background: #67C23A; border:none;">ç»™TAè½¬è´¦</button>
                        <button class="btn" onclick="doTransfer('from_ai')" style="background: white; color: #67C23A; border: 1px solid #67C23A;">å‘TAæ”¶æ¬¾</button>
                    </div>
                </div>
            </div>
        </div>
    


        
        <!-- === ğŸµ éŸ³ä¹æ’­æ”¾å™¨ç•Œé¢ === -->
    <div id="music-player-modal">
        <!-- é¡¶éƒ¨æœ€å°åŒ–æŒ‰é’® -->
        <div style="position: absolute; top: 40px; left: 20px;" onclick="minimizeMusicPlayer()">
            <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><path d="M19 12H5"></path></svg> <!-- ç®€å•çš„æ¨ªçº¿ä»£è¡¨æœ€å°åŒ– -->
        </div>
        <!-- æ­Œå•æŒ‰é’® -->
        <div style="position: absolute; top: 40px; right: 20px;" onclick="openMusicList()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>
        </div>

        <div class="music-info-top">
            <div class="music-title" id="player-title">æœªæ’­æ”¾</div>
            <div class="music-artist" id="player-artist">ç‚¹å‡»å³ä¸Šè§’æ·»åŠ æ­Œæ›²</div>
        </div>

        <!-- å”±ç‰‡ -->
        <div class="vinyl-wrapper" id="vinyl-disc">
            <div class="vinyl-cover" id="player-cover" style="background-image: url('https://cdn-icons-png.flaticon.com/512/1256/1256650.png');"></div>
        </div>

        <!-- äº¤äº’çŠ¶æ€ -->
        <div style="margin-top: 20px; font-size: 12px; color: rgba(255,255,255,0.6); height: 20px;" id="music-ai-status">
            æ­£åœ¨ç­‰å¾…ä¸€èµ·å¬...
        </div>

        <!-- æ§åˆ¶æ  -->
        <div class="player-controls">
            <!-- ä¸Šä¸€é¦– -->
            <div class="ctrl-btn" onclick="playPrevSong()">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="19 20 9 12 19 4 19 20"></polygon><line x1="5" y1="19" x2="5" y2="5"></line></svg>
            </div>
            <!-- æ’­æ”¾/æš‚åœ -->
            <div class="ctrl-btn ctrl-btn-big" onclick="togglePlayState()">
                <svg id="play-icon" width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>
                <svg id="pause-icon" style="display:none" width="30" height="30" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>
            </div>
            <!-- ä¸‹ä¸€é¦– -->
            <div class="ctrl-btn" onclick="playNextSong()">
                <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>
            </div>
        </div>
        
        <!-- éŸ³é¢‘æ ‡ç­¾ (éšè—) -->
        <audio id="bgm-audio" loop></audio>
    </div>

    <!-- === ğŸµ æ­Œå•åˆ—è¡¨å¼¹çª— === -->
    <div id="music-list-modal">
        <div style="padding: 15px; border-bottom: 1px solid #eee; display:flex; justify-content:space-between; align-items:center;">
            <div style="font-weight:bold; color:#333;">æˆ‘çš„æ­Œå•</div>
            <div onclick="document.getElementById('music-list-modal').style.display='none'" style="color:#999; font-size:24px;">Ã—</div>
        </div>
        
        <div style="flex:1; overflow-y: auto;" id="music-list-container">
            <!-- æ­Œæ›²åˆ—è¡¨ -->
        </div>
        
        <div style="padding: 15px; border-top: 1px solid #eee;">
            <div style="display:flex; gap:10px;">
                <input type="text" id="net-music-input" class="cute-input" placeholder="ç²˜è´´ç½‘æ˜“äº‘é“¾æ¥æˆ–ID..." style="font-size:12px;">
                <button class="btn" style="width: auto; padding: 0 15px; margin-top:0;" onclick="importMusic()">æ·»åŠ </button>
            </div>
            <div class="helper-text">æç¤ºï¼šVIPæ­Œæ›²æ— æ³•æ’­æ”¾ï¼Œè¯·ç”¨å…è´¹æ­Œæ›²ID</div>
        </div>
    </div>
        <!-- â–²â–²â–²â–²â–² é¢æ¿ç»“æŸ â–²â–²â–²â–²â–² -->
        <!-- â–²â–²â–²â–²â–² æ’å…¥ç»“æŸ â–²â–²â–²â–²â–² -->

        <div class="room-footer">
            <!-- â–¼â–¼â–¼ æ–°å¢ï¼šåŠ å·æŒ‰é’® â–¼â–¼â–¼ -->
            <div class="action-btn" style="color: #5A6A7E; background: transparent; border: 1px solid #E0E0E0; margin-right: 5px;" onclick="toggleChatActionPanel()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>

            <!-- æ¥æ”¶æŒ‰é’® (æ°”æ³¡å›¾æ ‡) -->
            <div class="action-btn btn-receive" onclick="triggerAIResponse()" title="è®©å¯¹æ–¹å›å¤">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            
            <textarea id="msg-input" class="chat-input-box" rows="1" placeholder="è¾“å…¥æ¶ˆæ¯..."></textarea>
            
            <!-- å‘é€æŒ‰é’® -->
            <div class="action-btn btn-send" onclick="sendUserMessage()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="22" y1="2" x2="11" y2="13"></line>
                    <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                </svg>
            </div>
        </div>
    </div>

    <!-- === 6. èŠå¤©è®¾ç½®é¡µé¢ (ç‹¬ç«‹) === -->
    <div id="chat-settings-page">
        <div class="api-header">
            <div class="api-back-btn" onclick="closeChatSettings()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
            </div>
            <h2>èŠå¤©è®¾ç½®</h2>
        </div>

        <div style="flex: 1; overflow-y: auto; padding-bottom: 40px;">
            
            <!-- å¤–è§‚è®¾ç½® -->
            <div style="margin: 20px 20px 10px 20px; font-size: 12px; color: #999; font-weight: bold;">å¤–è§‚æ ·å¼</div>
            <div class="setting-section">
                <div class="setting-item">
                    <span class="setting-title">æ°”æ³¡å½¢çŠ¶</span>
                    <div class="shape-selector">
                        <div class="shape-opt bubble-round" onclick="setBubbleShape('bubble-round', this)" title="åœ†æ»šæ»š"></div>
                        <div class="shape-opt bubble-default active" onclick="setBubbleShape('bubble-default', this)" title="é»˜è®¤"></div>
                        <div class="shape-opt bubble-sharp" onclick="setBubbleShape('bubble-sharp', this)" title="å°å°–è§’"></div>
                    </div>
                </div>
                <div class="setting-item">
                    <span class="setting-title">èŠå¤©èƒŒæ™¯</span>
                    <button class="btn-secondary" onclick="document.getElementById('chat-bg-upload').click()" style="font-size: 12px;">ä¸Šä¼ å›¾ç‰‡</button>
                    <input type="file" id="chat-bg-upload" class="hidden-input" accept="image/*">
                </div>
            </div>

            <!-- é¢œè‰²è®¾ç½® -->
            <div style="margin: 20px 20px 10px 20px; font-size: 12px; color: #999; font-weight: bold;">æ°”æ³¡é…è‰² (æ¡æ‰‹æœºæ–‡å­¦é£)</div>
            <div class="setting-section">
                <div class="setting-item">
                    <span class="setting-title">å¯¹æ–¹æ°”æ³¡ (AI)</span>
                    <input type="color" id="color-ai" value="#FFFFFF" onchange="updateChatColors()">
                </div>
                <div class="setting-item">
                    <span class="setting-title">æˆ‘çš„æ°”æ³¡ (User)</span>
                    <input type="color" id="color-user" value="#FFE6E6" onchange="updateChatColors()">
                </div>
            </div>

            <!-- å‚æ•°è®¾ç½® -->
            <div style="margin: 20px 20px 10px 20px; font-size: 12px; color: #999; font-weight: bold;">æ˜¾ç¤ºä¸è®°å¿†</div>
            <div class="setting-item">
                    <span class="setting-title">æ˜¾ç¤ºæ—¶é—´æˆ³</span>
                    <input type="checkbox" id="show-time-switch" onchange="updateChatSettingsBool()" style="width: 20px; height: 20px;">
                </div>
            <div class="setting-section">
                <div class="setting-item">
                    <span class="setting-title">å­—ä½“å¤§å° (12-15px)</span>
                    <input type="number" id="font-size-input" value="14" min="12" max="15" class="cute-input" style="width: 60px; padding: 5px; text-align: center;" onchange="updateChatFont()">
                </div>
                <div class="setting-item">
                    <span class="setting-title">è®°å¿†æ¡æ•°</span>
                    <input type="number" id="memory-limit" value="30" class="cute-input" style="width: 60px; padding: 5px; text-align: center;">
                </div>
            </div>
            
            <!-- æ–°å¢ï¼šéšç§ä¸åŠ¨æ€ -->
            <div style="margin: 20px 20px 10px 20px; font-size: 12px; color: #999; font-weight: bold;">éšç§ä¸åŠ¨æ€</div>
            <div class="setting-section">
                <div class="setting-item" onclick="peekRoleInfo('memo')">
                    <span class="setting-title">ğŸ“… æŸ¥çœ‹TAçš„å¤‡å¿˜å½•</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <div class="setting-item" onclick="peekRoleInfo('footprint')">
                    <span class="setting-title">ğŸ‘£ æŸ¥çœ‹TAçš„è¶³è¿¹</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <div class="setting-item" onclick="peekRoleInfo('note')">
                    <span class="setting-title">ğŸ’­ å·çœ‹ç¢ç¢å¿µç¬”è®°</span>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            </div>
            
            <!-- é€šç”¨ä¿¡æ¯å±•ç¤ºå¼¹çª— -->
    <div id="info-modal" onclick="document.getElementById('info-modal').style.display='none'">
        <div class="info-card" onclick="event.stopPropagation()">
            <div class="info-header" id="info-title">æ ‡é¢˜</div>
            <div class="info-content" id="info-text">å†…å®¹åŠ è½½ä¸­...</div>
            <button class="btn" onclick="document.getElementById('info-modal').style.display='none'" style="margin-top:20px; background:#f5f5f5; color:#666;">å…³é—­</button>
        </div>
    </div>
            
            <div style="text-align: center; margin-top: 30px; color: #ccc; font-size: 12px;">
                è®¾ç½®ä¼šè‡ªåŠ¨ä¿å­˜
            </div>
        </div>
    </div>
    
    <!-- é•¿æŒ‰æ¶ˆæ¯å¼¹å‡ºçš„èœå• -->
    <div id="msg-context-menu" onclick="closeMsgMenu()">
        <div class="menu-content" onclick="event.stopPropagation()">
            <div class="menu-item" onclick="handleEditMsg()">âœ ç¼–è¾‘æ¶ˆæ¯</div>
            <div class="menu-item danger" onclick="handleDeleteMsg()">ğŸ—‘ åˆ é™¤æ¶ˆæ¯</div>
        </div>
    </div>
        
    </div>   

    <script>
    // --- æ–°å¢å˜é‡ï¼šæ§åˆ¶æ˜¾ç¤ºæ¡æ•° ---
        let visibleMsgCount = 30; // é»˜è®¤åªçœ‹æœ€è¿‘30æ¡
        let selectedMsgIndex = -1; // å½“å‰é•¿æŒ‰é€‰ä¸­çš„æ˜¯å“ªæ¡æ¶ˆæ¯
    
    
        /* --- 1. åŸºç¡€åŠŸèƒ½ï¼šæ—¶é—´ä¸ç”µæ±  --- */
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            document.getElementById('main-clock').innerText = `${hours}:${minutes}`;
            document.getElementById('status-time').innerText = `${hours}:${minutes}`;
        }
        setInterval(updateClock, 1000);
        updateClock();

        if ('getBattery' in navigator) {
            navigator.getBattery().then(function(battery) {
                function updateBattery() {
                    const level = Math.round(battery.level * 100);
                    document.getElementById('battery-percent').innerText = level + '%';
                    document.getElementById('battery-fill').style.width = level + '%';
                    if(level <= 20) document.getElementById('battery-fill').style.backgroundColor = '#ff4d4f';
                    else document.getElementById('battery-fill').style.backgroundColor = '#5A6A7E';
                }
                updateBattery();
                battery.addEventListener('levelchange', updateBattery);
            });
        }

        /* --- 2. ç¾åŒ–åŠŸèƒ½ï¼šä¸Šä¼ å›¾ç‰‡ --- */
        function handleImageUpload(inputId, targetId, isBg = false) {
            document.getElementById(inputId).addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const target = document.getElementById(targetId);
                        target.style.backgroundImage = `url(${event.target.result})`;
                        if(!isBg) target.innerText = ''; 
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        handleImageUpload('bg-upload', 'wallpaper-layer', true);
        handleImageUpload('avatar-upload', 'avatar-box');

        /* --- 3. åº”ç”¨åŠŸèƒ½ï¼šAPI è®¾ç½® --- */
        function openApp(appId) {
            document.getElementById(appId).style.display = 'flex';
            loadSettings();
        }

        function closeApp(appId) {
            document.getElementById(appId).style.display = 'none';
        }

        function saveSettings() {
            const config = {
                url: document.getElementById('api-url').value,
                key: document.getElementById('api-key').value,
                model: document.getElementById('model-select').value,
                temp: document.getElementById('api-temp').value
            };
            localStorage.setItem('my_ai_config', JSON.stringify(config));
            alert('é…ç½®å·²ä¿å­˜ï¼');
        }

        function loadSettings() {
            const saved = localStorage.getItem('my_ai_config');
            if (saved) {
                const config = JSON.parse(saved);
                if(config.url) document.getElementById('api-url').value = config.url;
                if(config.key) document.getElementById('api-key').value = config.key;
                if(config.temp) document.getElementById('api-temp').value = config.temp;
                if(config.model) {
                    const select = document.getElementById('model-select');
                    if(select.options.length <= 1) {
                        const option = document.createElement('option');
                        option.value = config.model;
                        option.text = config.model + " (å·²ä¿å­˜)";
                        option.selected = true;
                        select.add(option);
                    }
                }
            }
        }

        async function fetchModels() {
            const url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            const select = document.getElementById('model-select');

            if (!url || !key) {
                alert('è¯·å…ˆå¡«å†™ API URL å’Œ Key');
                return;
            }
            select.innerHTML = '<option>æ­£åœ¨åŠ è½½...</option>';
            try {
                const fetchUrl = url.endsWith('/') ? `${url}models` : `${url}/models`;
                const response = await fetch(fetchUrl, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${key}`,
                        'Content-Type': 'application/json'
                    }
                });
                if (!response.ok) throw new Error('è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ URL å’Œ Key');
                const data = await response.json();
                select.innerHTML = ''; 
                const models = Array.isArray(data) ? data : (data.data || []);
                if (models.length === 0) {
                    select.innerHTML = '<option>æœªæ‰¾åˆ°æ¨¡å‹</option>';
                    return;
                }
                models.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.id;
                    option.text = m.id;
                    select.appendChild(option);
                });
                alert(`æˆåŠŸè·å– ${models.length} ä¸ªæ¨¡å‹ï¼`);
            } catch (error) {
                console.error(error);
                select.innerHTML = '<option value="" disabled selected>è·å–å¤±è´¥</option>';
                alert('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥ï¼š' + error.message);
            }
        }
        
        /* --- 4. Chat åº”ç”¨é€»è¾‘ --- */
        let chatList = [
            {
                id: 'system_1',
                name: 'æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹',
                avatar: 'https://cdn-icons-png.flaticon.com/512/4825/4825038.png',
                prompt: 'System',
                gender: 'ç³»ç»Ÿ',
                lastMsg: 'å›¾ç‰‡å·²ä¿å­˜',
                time: '12:30'
            }
        ];
        let selectedGender = 'ç”·ç”Ÿ'; 
        let tempRoleAvatar = ''; 

        function openChatApp() {
            openApp('chat-app');
            renderChatList();
            const firstTab = document.querySelectorAll('.bottom-nav .nav-item')[0];
            switchChatTab('chats', firstTab);
        }

        function switchChatTab(tabName, navEl) {
    // éšè—æ‰€æœ‰é¡µé¢å’ŒæŒ‰é’®çš„æ¿€æ´»çŠ¶æ€
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.chat-content-area').forEach(el => el.style.display = 'none');
    
    // æ¿€æ´»å½“å‰ç‚¹å‡»çš„
    navEl.classList.add('active');
    document.getElementById('tab-' + tabName).style.display = 'block';

    // æ›´æ–°æ ‡é¢˜
    const titles = { 'chats': 'Chats', 'contacts': 'Contacts', 'me': 'æˆ‘' };
    document.getElementById('chat-page-title').innerText = titles[tabName];
    
    // ç‰¹æ®ŠæŒ‰é’®çš„æ˜¾ç¤º/éšè—
    if (tabName === 'contacts') {
        document.getElementById('add-contact-btn').style.display = 'block';
        renderContactList(); 
    } else {
        document.getElementById('add-contact-btn').style.display = 'none';
    }
    
    // å¦‚æœæ˜¯â€œæˆ‘â€é¡µé¢ï¼Œæœªæ¥å¯ä»¥åœ¨è¿™é‡Œè°ƒç”¨æ¸²æŸ“å‡½æ•°
    if (tabName === 'me') {
        // renderMePage(); // æš‚æ—¶å…ˆç©ºç€
    }
}

        function renderChatList() {
            const container = document.getElementById('tab-chats');
            container.innerHTML = ''; 
            chatList.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'chat-item-card';
                div.onclick = function() { enterChatRoom(chat.id); };
                div.innerHTML = `
                    <div class="chat-avatar" style="background-image: url('${chat.avatar}');"></div>
                    <div class="chat-info">
                        <div class="chat-name">${chat.name}</div>
                        <div class="chat-preview">${chat.lastMsg}</div>
                    </div>
                    <div class="chat-time">${chat.time}</div>
                `;
                container.appendChild(div);
            });
            container.appendChild(createSpacer());
        }

        function renderContactList() {
            const container = document.getElementById('contact-list');
            container.innerHTML = '';
            chatList.forEach(chat => {
                const div = document.createElement('div');
                div.className = 'contact-item';
                div.innerHTML = `
                    <div class="contact-avatar" style="background-image: url('${chat.avatar}');"></div>
                    <div style="flex:1;">
                        <span class="contact-name">${chat.name}</span>
                        ${chat.gender ? `<span class="contact-tag">${chat.gender}</span>` : ''}
                    </div>
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ccc" stroke-width="2"><path d="M9 18l6-6-6-6"/></svg>
                `;
                div.onclick = function() { 
                    const chatTabBtn = document.querySelectorAll('.bottom-nav .nav-item')[0];
                    switchChatTab('chats', chatTabBtn);
                };
                container.appendChild(div);
            });
            container.appendChild(createSpacer());
        }

        function createSpacer() {
            const d = document.createElement('div');
            d.style.height = "80px";
            return d;
        }

        // --- åˆ›å»ºè§’è‰²é¡µé¢é€»è¾‘ ---
        function showCreatePage() {
            document.getElementById('create-role-page').style.display = 'flex';
        }

        function hideCreatePage() {
            document.getElementById('create-role-page').style.display = 'none';
        }

        function selectGender(el, val) {
            document.querySelectorAll('.gender-opt').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
            selectedGender = val;
        }

        // ç›‘å¬è§’è‰²å¤´åƒä¸Šä¼  (æ–°ç‰ˆé€»è¾‘)
        document.getElementById('role-file').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    tempRoleAvatar = event.target.result;
                    const target = document.getElementById('new-role-avatar');
                    target.style.backgroundImage = `url(${tempRoleAvatar})`;
                    // éšè—é‡Œé¢çš„æ–‡å­—å’Œå›¾æ ‡
                    target.innerHTML = ''; 
                };
                reader.readAsDataURL(file);
            }
        });

        function createNewRole() {
            const name = document.getElementById('role-name').value;
            const prompt = document.getElementById('role-prompt').value;
            
            if(!name) { alert('è¯·å¡«å†™åå­—'); return; }

            const newRole = {
                id: 'role_' + Date.now(),
                name: name,
                avatar: tempRoleAvatar || 'https://cdn-icons-png.flaticon.com/512/847/847969.png',
                prompt: prompt,
                gender: selectedGender,
                lastMsg: 'ä½ å¥½å‘€ï¼',
                time: 'åˆšåˆš'
            };

            chatList.unshift(newRole); 

            // æ¸…ç†è¡¨å•
            document.getElementById('role-name').value = '';
            document.getElementById('role-prompt').value = '';
            document.getElementById('new-role-avatar').style.backgroundImage = '';
            // æ¢å¤ä¸Šä¼ å›¾æ ‡
            document.getElementById('new-role-avatar').innerHTML = `
                <div style="text-align:center;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    <div style="margin-top:4px;">ä¸Šä¼ å¤´åƒ</div>
                </div>`;
            tempRoleAvatar = '';

            hideCreatePage(); 
            renderContactList();
            alert('è”ç³»äºº ' + name + ' åˆ›å»ºæˆåŠŸï¼');
        }
        
        /* --- 5. èŠå¤©å®¤æ ¸å¿ƒé€»è¾‘ --- */

        let currentChatId = null; // å½“å‰æ­£åœ¨èŠå¤©çš„è§’è‰²ID
        let chatHistory = {};     // å­˜å‚¨æ‰€æœ‰è§’è‰²çš„èŠå¤©è®°å½• { roleId: [messages] }
        
        // é»˜è®¤è®¾ç½®
        let chatSettings = {
            bubbleShape: 'bubble-default',
            aiColor: '#FFFFFF',
            userColor: '#FFE6E6',
            fontSize: '14px',
            memoryLimit: 30,
            bgImage: '' // èŠå¤©èƒŒæ™¯å›¾
        };

        // åˆå§‹åŒ–ï¼šåŠ è½½è®¾ç½®
        function initChatSettings() {
            const saved = localStorage.getItem('yok_chat_settings');
            if(saved) {
                chatSettings = JSON.parse(saved);
                // æ¢å¤UIæ˜¾ç¤º
                document.getElementById('color-ai').value = chatSettings.aiColor;
                document.getElementById('color-user').value = chatSettings.userColor;
                document.getElementById('font-size-input').value = parseInt(chatSettings.fontSize);
                document.getElementById('memory-limit').value = chatSettings.memoryLimit;
                
                // æ¢å¤èƒŒæ™¯
                if(chatSettings.bgImage) {
                    document.getElementById('chat-room-page').style.backgroundImage = `url(${chatSettings.bgImage})`;
                }
                
                // æ¢å¤å½¢çŠ¶é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.shape-opt').forEach(el => {
                    el.classList.remove('active');
                    if(el.classList.contains(chatSettings.bubbleShape)) el.classList.add('active');
                });
            }
        }
        
                if(chatSettings.showTime !== undefined) {
                    document.getElementById('show-time-switch').checked = chatSettings.showTime;
                }
                
        initChatSettings(); // è¿è¡Œåˆå§‹åŒ–

        // æ‰“å¼€èŠå¤©å®¤ (ä¿®æ”¹ä¹‹å‰çš„ onclick é€»è¾‘)
        // æ³¨æ„ï¼šä½ éœ€è¦ä¿®æ”¹ renderContactList å’Œ renderChatList é‡Œçš„ onclick äº‹ä»¶è°ƒç”¨è¿™ä¸ªå‡½æ•°
        // ä¾‹å¦‚ï¼šdiv.onclick = function() { enterChatRoom(chat.id); };
        function enterChatRoom(roleId) {
            currentChatId = roleId;
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šæ¯æ¬¡è¿›æˆ¿é—´ï¼Œé‡ç½®åªçœ‹æœ€å30æ¡ â˜…â˜…â˜…
            visibleMsgCount = 30; 

            const role = chatList.find(r => r.id === roleId);
            if(!role) return;

            document.getElementById('current-chat-name').innerText = role.name;
            document.getElementById('chat-room-page').style.display = 'flex';

            // â–¼â–¼â–¼ æ–°å¢è¿™è¡Œï¼šç‚¹å‡»æ¶ˆæ¯åŒºåŸŸï¼Œæ”¶èµ·é¢æ¿ â–¼â–¼â–¼
            document.getElementById('message-container').onclick = () => {
                document.getElementById('chat-action-panel').classList.remove('active');
            };
            
            if (!chatHistory[roleId]) {
                chatHistory[roleId] = []; // ç°åœ¨æ˜¯ç©ºçš„äº†ï¼Œè¿›å»ä»€ä¹ˆéƒ½æ²¡æœ‰
            }
            
            renderMessages();
        }

        function closeChatRoom() {
            document.getElementById('chat-room-page').style.display = 'none';
            currentChatId = null;
        }

        // æ¸²æŸ“æ¶ˆæ¯ (å‡çº§ç‰ˆï¼šé˜²å¡é¡¿ + é•¿æŒ‰èœå• + æŸ¥çœ‹æ›´å¤š)
        function renderMessages(keepScrollPosition = false) {
            const container = document.getElementById('message-container');
            // è®°å½•å½“å‰æ»šåŠ¨é«˜åº¦ï¼Œç”¨äºâ€œåŠ è½½æ›´å¤šâ€æ—¶ä¿æŒä½ç½®
            const oldScrollHeight = container.scrollHeight;
            const oldScrollTop = container.scrollTop;

            container.innerHTML = '';
            const allMsgs = chatHistory[currentChatId] || [];
            
            // â˜…â˜…â˜… 1. åˆ‡å‰²æ•°ç»„ï¼Œåªå–æœ€å N æ¡ â˜…â˜…â˜…
            const startIndex = Math.max(0, allMsgs.length - visibleMsgCount);
            const displayMsgs = allMsgs.slice(startIndex);

            // â˜…â˜…â˜… 2. å¦‚æœè¿˜æœ‰æ›´å¤šå†å²ï¼Œæ˜¾ç¤ºâ€œç‚¹å‡»åŠ è½½æ›´å¤šâ€ â˜…â˜…â˜…
            if (startIndex > 0) {
                const loadBtn = document.createElement('div');
                loadBtn.className = 'load-more-btn';
                loadBtn.innerText = 'æŸ¥çœ‹æ›´å¤šå†å²æ¶ˆæ¯...';
                loadBtn.onclick = loadMoreHistory;
                container.appendChild(loadBtn);
            }

            // è·å–å¤´åƒ
            const aiRole = chatList.find(r => r.id === currentChatId);
            const aiAvatar = aiRole ? aiRole.avatar : '';
            let userAvatar = 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png';
            if (activePersonaId) {
                const p = myPersonas.find(x => x.id === activePersonaId);
                if (p) userAvatar = p.avatar;
            }

            // â˜…â˜…â˜… 3. å¾ªç¯æ¸²æŸ“ â˜…â˜…â˜…
            displayMsgs.forEach((msg, i) => {
                // è®¡ç®—è¯¥æ¶ˆæ¯åœ¨åŸå§‹å¤§æ•°ç»„ä¸­çš„çœŸå®ç´¢å¼•
                const realIndex = startIndex + i;

                const row = document.createElement('div');
                row.className = `msg-row ${msg.role === 'user' ? 'right' : 'left'}`;
                
                const avatarHtml = `
                    <div class="msg-avatar-container">
                        <div class="msg-avatar-img" style="background-image: url('${msg.role === 'user' ? userAvatar : aiAvatar}')"></div>
                        ${chatSettings.showTime ? `<div class="msg-timestamp">${msg.time || ''}</div>` : ''}
                    </div>
                `;

                const bubbleDiv = document.createElement('div');
                bubbleDiv.className = `msg-bubble ${chatSettings.bubbleShape}`;

                if (msg.content.includes('<img') || msg.content.includes('transfer-card')) {
                    bubbleDiv.classList.add('bubble-transparent');
                } else {
                    bubbleDiv.style.fontSize = chatSettings.fontSize;
                    if (msg.role === 'user') {
                        bubbleDiv.style.backgroundColor = chatSettings.userColor;
                        bubbleDiv.style.color = '#333';
                    } else {
                        bubbleDiv.style.backgroundColor = chatSettings.aiColor;
                        bubbleDiv.style.color = '#333';
                    }
                }
                bubbleDiv.innerHTML = msg.content;

                // â˜…â˜…â˜… 4. ç»‘å®šé•¿æŒ‰äº‹ä»¶ (æ ¸å¿ƒ) â˜…â˜…â˜…
                addLongPressEvent(bubbleDiv, realIndex);

                if (msg.role === 'user') {
                    row.appendChild(bubbleDiv);
                    row.appendChild(createRangeElement(avatarHtml));
                } else {
                    row.appendChild(createRangeElement(avatarHtml));
                    row.appendChild(bubbleDiv);
                }

                container.appendChild(row);
            });
            
            // â˜…â˜…â˜… 5. æ»šåŠ¨å¤„ç† â˜…â˜…â˜…
            if (keepScrollPosition) {
                // å¦‚æœæ˜¯ç‚¹å‡»â€œåŠ è½½æ›´å¤šâ€ï¼Œä¿æŒè§†çº¿ä½ç½®ä¸å˜
                container.scrollTop = container.scrollHeight - oldScrollHeight + oldScrollTop;
            } else {
                // å¦‚æœæ˜¯æ–°æ¶ˆæ¯ï¼Œæ»šåˆ°åº•éƒ¨
                container.scrollTop = container.scrollHeight;
            }
        }

        // è¾…åŠ©å‡½æ•°ï¼šæŠŠHTMLå­—ç¬¦ä¸²è½¬æˆDOMå…ƒç´ 
        function createRangeElement(html) {
            const template = document.createElement('template');
            template.innerHTML = html.trim();
            return template.content.firstChild;
        }
        
        // æ›´æ–°è®¾ç½® (ä¿®å¤ç‰ˆï¼šç‚¹å‡»ç«‹åˆ»ç”Ÿæ•ˆ)
        function updateChatSettingsBool() {
            chatSettings.showTime = document.getElementById('show-time-switch').checked;
            // ç«‹åˆ»ä¿å­˜
            localStorage.setItem('yok_chat_settings', JSON.stringify(chatSettings));
            // ç«‹åˆ»åˆ·æ–°ç•Œé¢ï¼Œè¿™æ ·ä½ å°±èƒ½é©¬ä¸Šçœ‹åˆ°æ—¶é—´æˆ³å‡ºæ¥äº†
            renderMessages(); 
        }

        // å‘é€æ¶ˆæ¯ (ä¿®å¤ç‰ˆï¼šè®°å½•æ—¶é—´)
        function sendUserMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if (!text) return;

            // è·å–å½“å‰æ—¶é—´
            const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

            // æ·»åŠ åˆ°å†å² (æ³¨æ„è¿™é‡ŒåŠ äº† time å­—æ®µ)
            chatHistory[currentChatId].push({ role: 'user', content: text, time: timeStr });
            
            renderMessages();
            input.value = ''; 
            
            updateListPreview(text);
        }

        // è§¦å‘ AI å›å¤ (ç‚¹å‡»æ¥æ”¶æŒ‰é’®)
        async function triggerAIResponse() {
            if (!currentChatId) return;
            
            const role = chatList.find(r => r.id === currentChatId);
            const msgs = chatHistory[currentChatId];
            
            // æ˜¾ç¤ºæ­£åœ¨è¾“å…¥
            const statusEl = document.getElementById('typing-status');
            statusEl.classList.add('typing');
            
            // å‡†å¤‡ API æ•°æ®
            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            if (!config.url || !config.key) {
                alert('è¯·å…ˆåœ¨ä¸»å±å¹•è®¾ç½® APIï¼');
                statusEl.classList.remove('typing');
                return;
            }

            // æ„é€ ä¸Šä¸‹æ–‡ (å¸¦è®°å¿†é™åˆ¶)
            const limit = parseInt(chatSettings.memoryLimit) || 30;
            const recentMsgs = msgs.slice(-limit).map(m => ({
                role: m.role === 'user' ? 'user' : 'assistant',
                content: m.content
            }));

            // åŠ å…¥äººè®¾ System Prompt
            const systemPrompt = {
                role: 'system',
                content: `ä½ ç°åœ¨æ‰®æ¼”ï¼š${role.name}ã€‚\näººè®¾è®¾å®šï¼š${role.prompt || 'æ— '}ã€‚\nè¯·ç”¨ç¬¦åˆäººè®¾çš„è¯­æ°”å›å¤ï¼Œä¸è¦è·³å‡ºè§’è‰²ã€‚`
            };
            
            const messagesToSend = [systemPrompt, ...recentMsgs];

            try {
                const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
                
                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: config.model || 'gpt-3.5-turbo',
                        messages: messagesToSend,
                        temperature: parseFloat(config.temp) || 0.7
                    })
                });

                if (!response.ok) throw new Error('API è¯·æ±‚å¤±è´¥');
                
                const data = await response.json();
                const reply = data.choices[0].message.content;

                // æ·»åŠ å›å¤
                chatHistory[currentChatId].push({ role: 'ai', content: reply });
                renderMessages();
                updateListPreview(reply);

            } catch (error) {
                console.error(error);
                chatHistory[currentChatId].push({ role: 'ai', content: '[ç³»ç»Ÿé”™è¯¯: æ— æ³•è¿æ¥ AI]' });
                renderMessages();
            } finally {
                statusEl.classList.remove('typing');
            }
        }
        
        function updateListPreview(text) {
             const role = chatList.find(r => r.id === currentChatId);
             if(role) {
                 role.lastMsg = text;
                 role.time = 'åˆšåˆš';
                 // åˆ·æ–°å¤–éƒ¨åˆ—è¡¨
                 if(document.getElementById('tab-chats').style.display !== 'none') renderChatList();
                 if(document.getElementById('tab-contacts').style.display !== 'none') renderContactList();
             }
        }

        /* --- 6. èŠå¤©è®¾ç½®é€»è¾‘ --- */
        
        function openChatSettings() {
            document.getElementById('chat-settings-page').style.display = 'flex';
        }
        function closeChatSettings() {
            document.getElementById('chat-settings-page').style.display = 'none';
            // å…³é—­æ—¶ä¿å­˜
            localStorage.setItem('yok_chat_settings', JSON.stringify(chatSettings));
            // åˆ·æ–°èŠå¤©å®¤æ ·å¼
            renderMessages();
        }

        function setBubbleShape(shapeClass, el) {
            chatSettings.bubbleShape = shapeClass;
            document.querySelectorAll('.shape-opt').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }

        function updateChatColors() {
            chatSettings.aiColor = document.getElementById('color-ai').value;
            chatSettings.userColor = document.getElementById('color-user').value;
        }

        function updateChatFont() {
            const size = document.getElementById('font-size-input').value;
            chatSettings.fontSize = size + 'px';
        }
        
        // èŠå¤©èƒŒæ™¯ä¸Šä¼ 
        document.getElementById('chat-bg-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    chatSettings.bgImage = event.target.result;
                    document.getElementById('chat-room-page').style.backgroundImage = `url(${chatSettings.bgImage})`;
                };
                reader.readAsDataURL(file);
            }
        });
        

        /* --- 7. â€œæˆ‘â€çš„å­é¡µé¢åŠŸèƒ½ (å‡çº§ç‰ˆ) --- */

        function openMeSubPage(pageId) {
            document.getElementById(pageId).style.display = 'flex';
            if (pageId === 'me-persona-page') {
                renderPersonaList();
            }
            if (pageId === 'me-anniversary-page') {
                renderAnniversaries();
                updateAnniversaryRoleSelect();
            }
            // â–¼â–¼â–¼ åŠ ä¸Šè¿™ 3 è¡Œä»£ç  â–¼â–¼â–¼
            if (pageId === 'me-sticker-page') {
            updateStickerRoleSelect(); // <--- æ–°å¢è¿™ä¸€è¡Œ
                renderStickers();
            }
        }
            

        function closeMeSubPage(pageId) {
            document.getElementById(pageId).style.display = 'none';
        }

        /* --- A. å¤šäººè®¾ç®¡ç†é€»è¾‘ --- */
        let myPersonas = JSON.parse(localStorage.getItem('yok_my_personas')) || [];
        let activePersonaId = localStorage.getItem('yok_active_persona_id') || null;
        let tempPersonaAvatar = ''; // ä¸´æ—¶å­˜å¤´åƒ

        // 1. æ‰“å¼€æ–°å»ºé¡µ
        function openPersonaCreate() {
            document.getElementById('persona-create-page').style.display = 'flex';
            // é‡ç½®è¡¨å•
            document.getElementById('persona-name-input').value = '';
            document.getElementById('persona-desc-input').value = '';
            tempPersonaAvatar = '';
            document.getElementById('persona-avatar-preview').style.backgroundImage = '';
            document.getElementById('persona-avatar-preview').innerHTML = `<div style="text-align:center;"><div style="font-size: 24px;">ğŸ“·</div><div style="margin-top:4px;">äººè®¾å¤´åƒ</div></div>`;
        }

        // 2. ç›‘å¬äººè®¾å¤´åƒä¸Šä¼ 
        document.getElementById('persona-file-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    tempPersonaAvatar = event.target.result;
                    const target = document.getElementById('persona-avatar-preview');
                    target.style.backgroundImage = `url(${tempPersonaAvatar})`;
                    target.innerHTML = ''; 
                };
                reader.readAsDataURL(file);
            }
        });

        // 3. ä¿å­˜äººè®¾
        function saveNewPersona() {
            const name = document.getElementById('persona-name-input').value;
            const desc = document.getElementById('persona-desc-input').value;
            
            if (!name) { alert('èµ·ä¸ªåå­—å§ï¼'); return; }

            const newPersona = {
                id: 'p_' + Date.now(),
                name: name,
                avatar: tempPersonaAvatar || 'https://cdn-icons-png.flaticon.com/512/1077/1077114.png', // é»˜è®¤å¤´åƒ
                desc: desc
            };

            myPersonas.push(newPersona);
            localStorage.setItem('yok_my_personas', JSON.stringify(myPersonas));
            
            // è‡ªåŠ¨è®¾ä¸ºå½“å‰ä½¿ç”¨
            setActivePersona(newPersona.id);
            
            document.getElementById('persona-create-page').style.display = 'none';
            renderPersonaList();
        }

        // 4. æ¸²æŸ“äººè®¾åˆ—è¡¨
        function renderPersonaList() {
            const container = document.getElementById('persona-list-container');
            container.innerHTML = '';

            if (myPersonas.length === 0) {
                container.innerHTML = '<div style="text-align:center; padding:20px; color:#999;">è¿˜æ²¡æœ‰äººè®¾ï¼Œç‚¹å‡»å³ä¸Šè§’æ–°å»ºä¸€ä¸ªå§ï¼</div>';
                return;
            }

            myPersonas.forEach((p, index) => {
                const isActive = p.id === activePersonaId;
                const div = document.createElement('div');
                // å¤ç”¨èŠå¤©å¡ç‰‡æ ·å¼ï¼ŒåŠ ä¸€ç‚¹ä¿®æ”¹
                div.className = 'chat-item-card'; 
                div.style.border = isActive ? '2px solid var(--accent)' : '2px solid transparent';
                div.style.background = isActive ? '#F0F8FF' : 'white';
                
                div.innerHTML = `
                    <div class="chat-avatar" style="background-image: url('${p.avatar}'); width: 50px; height: 50px;"></div>
                    <div class="chat-info">
                        <div class="chat-name" style="font-size:15px;">${p.name} ${isActive ? '<span style="font-size:12px; color:var(--accent);">(ä½¿ç”¨ä¸­)</span>' : ''}</div>
                        <div class="chat-preview" style="font-size:12px;">${p.desc || 'æš‚æ— æè¿°'}</div>
                    </div>
                    <div style="color:#ff4d4f; padding:10px; font-size:20px;" onclick="deletePersona(event, ${index})">Ã—</div>
                `;
                div.onclick = (e) => {
                    // å¦‚æœç‚¹å‡»çš„æ˜¯åˆ é™¤æŒ‰é’®ï¼Œä¸è§¦å‘åˆ‡æ¢
                    if(e.target.innerText === 'Ã—') return;
                    setActivePersona(p.id);
                };
                container.appendChild(div);
            });
        }

        function setActivePersona(id) {
            activePersonaId = id;
            localStorage.setItem('yok_active_persona_id', id);
            renderPersonaList();
            
            // æ›´æ–°ä¸»ç•Œé¢å·¦ä¸Šè§’çš„å¤´åƒï¼ˆå¯é€‰ï¼‰
            const p = myPersonas.find(x => x.id === id);
            if(p) {
                document.getElementById('avatar-box').style.backgroundImage = `url(${p.avatar})`;
                document.getElementById('avatar-box').innerHTML = ''; // æ¸…é™¤æ–‡å­—
            }
        }

        function deletePersona(e, index) {
            e.stopPropagation();
            if(confirm('åˆ é™¤è¿™ä¸ªäººè®¾å¡ï¼Ÿ')) {
                const deletedId = myPersonas[index].id;
                myPersonas.splice(index, 1);
                localStorage.setItem('yok_my_personas', JSON.stringify(myPersonas));
                
                if (activePersonaId === deletedId) {
                    activePersonaId = null;
                    localStorage.removeItem('yok_active_persona_id');
                }
                renderPersonaList();
            }
        }


        /* --- B. çºªå¿µæ—¥ç»‘å®šé€»è¾‘ --- */
        let anniversaries = JSON.parse(localStorage.getItem('yok_anniversaries')) || [];

        // æ›´æ–°ä¸‹æ‹‰èœå•çš„é€‰é¡¹
        function updateAnniversaryRoleSelect() {
            const select = document.getElementById('anniversary-role-select');
            // ä¿ç•™ç¬¬ä¸€ä¸ªâ€œä¸ç»‘å®šâ€é€‰é¡¹ï¼Œæ¸…é™¤å…¶ä»–çš„
            select.innerHTML = '<option value="all">ä¸ç»‘å®š (æ‰€æœ‰äººéƒ½çŸ¥é“)</option>';
            
            chatList.forEach(role => {
                // æ’é™¤ç³»ç»Ÿè§’è‰²ï¼ˆå¦‚æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹ï¼‰
                if(role.id.startsWith('system_')) return;
                
                const opt = document.createElement('option');
                opt.value = role.id;
                opt.text = role.name;
                select.appendChild(opt);
            });
        }

        function renderAnniversaries() {
            const listContainer = document.getElementById('anniversary-list');
            listContainer.innerHTML = ''; 

            if (anniversaries.length === 0) {
                listContainer.innerHTML = '<div class="helper-text" style="text-align: center;">è¿˜æ²¡æœ‰çºªå¿µæ—¥ï¼Œå¿«æ·»åŠ ä¸€ä¸ªå§ï¼</div>';
                return;
            }

            anniversaries.forEach((item, index) => {
                // æŸ¥æ‰¾ç»‘å®šçš„è§’è‰²å
                let roleName = 'é€šç”¨';
                if (item.roleId && item.roleId !== 'all') {
                    const r = chatList.find(x => x.id === item.roleId);
                    roleName = r ? r.name : 'æœªçŸ¥è§’è‰²';
                }

                const div = document.createElement('div');
                div.className = 'anniversary-item';
                div.innerHTML = `
                    <div class="anniversary-info">
                        <span class="name">
                            <span style="background:#E3F2FD; color:#7FA6C8; font-size:10px; padding:2px 6px; border-radius:4px; margin-right:5px;">${roleName}</span>
                            ${item.name}
                        </span>
                        <span class="date">${item.date}</span>
                    </div>
                    <button class="delete-btn" onclick="deleteAnniversary(${index})">Ã—</button>
                `;
                listContainer.appendChild(div);
            });
        }

        function addAnniversary() {
            const nameInput = document.getElementById('anniversary-name');
            const dateInput = document.getElementById('anniversary-date');
            const roleSelect = document.getElementById('anniversary-role-select');

            if (!nameInput.value || !dateInput.value) {
                alert('è¯·å¡«å†™å®Œæ•´ä¿¡æ¯');
                return;
            }

            anniversaries.push({
                name: nameInput.value,
                date: dateInput.value,
                roleId: roleSelect.value // ä¿å­˜ç»‘å®šçš„è§’è‰²ID
            });
            
            localStorage.setItem('yok_anniversaries', JSON.stringify(anniversaries));
            renderAnniversaries();

            nameInput.value = '';
            dateInput.value = '';
        }
        
        function deleteAnniversary(index) {
             if (confirm('åˆ é™¤ï¼Ÿ')) {
                anniversaries.splice(index, 1);
                localStorage.setItem('yok_anniversaries', JSON.stringify(anniversaries));
                renderAnniversaries();
            }
        }
        
        // --- æ ¸å¿ƒ AI å›å¤é€»è¾‘ (ç»ˆæå®Œæ•´ç‰ˆï¼šå¸¦æ—¶é—´æ„ŸçŸ¥ + è¿å‘ + è½¬è´¦æ£€æµ‹) ---
        async function triggerAIResponse(contextInfo = '') {
            if (!currentChatId) return;
            
            const role = chatList.find(r => r.id === currentChatId);
            const msgs = chatHistory[currentChatId];
            
            const statusEl = document.getElementById('typing-status');
            statusEl.innerText = "å¯¹æ–¹æ­£åœ¨è¾“å…¥...";
            statusEl.classList.add('typing');
            
            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            if (!config.url || !config.key) {
                alert('è¯·å…ˆåœ¨ä¸»é¡µ-APIè®¾ç½®ä¸­å¡«å†™æ­£ç¡®çš„ Keyï¼');
                statusEl.classList.remove('typing');
                return;
            }

            // â˜…â˜…â˜… æ–°å¢ï¼šè·å–å½“å‰ç°å®æ—¶é—´ â˜…â˜…â˜…
            const now = new Date();
            const timeString = now.toLocaleString('zh-CN', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric', 
                weekday: 'long', 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: false 
            });
            // timeString çš„æ ·å­å¤§æ¦‚æ˜¯ï¼š "2023å¹´10æœˆ27æ—¥ æ˜ŸæœŸäº” 14:30"

            // 1. å‡†å¤‡ä¸Šä¸‹æ–‡
            let userPersonaText = "";
            if (activePersonaId) {
                const p = myPersonas.find(x => x.id === activePersonaId);
                if (p) userPersonaText = `\n\n[ç©å®¶è®¾å®š]\næ˜µç§°ï¼š${p.name}\næè¿°ï¼š${p.desc}`;
            }
            
            const relatedAnniversaries = anniversaries.filter(a => a.roleId === 'all' || a.roleId === currentChatId);
            let memoryText = "";
            if (relatedAnniversaries.length > 0) {
                memoryText = "\n\n[ä½ ä»¬çš„é‡è¦çºªå¿µæ—¥]\n";
                relatedAnniversaries.forEach(a => { memoryText += `- ${a.date}: ${a.name}\n`; });
            }
            
            const validStickersForAI = myStickers.filter(s => !s.roleId || s.roleId === 'all' || s.roleId === currentChatId);
            const stickerDescriptions = validStickersForAI.map(s => s.desc || 'æœªå‘½å').join(', ');

            // 2. æ„é€ æç¤ºè¯ (åŠ å…¥äº†æ—¶é—´)
            const fullSystemContent = `
[å½“å‰ç°å®æ—¶é—´]: ${timeString}
(è¯·æ ¹æ®å½“å‰æ—¶é—´åˆ¤æ–­æ˜¯æ—©æ™¨ã€ä¸­åˆè¿˜æ˜¯æ·±å¤œï¼Œå¹¶åšå‡ºç¬¦åˆæ—¶é—´çš„ååº”ã€‚)

ä½ ç°åœ¨æ‰®æ¼”ï¼š${role.name}ã€‚
äººè®¾è®¾å®šï¼š${role.prompt || 'æ— '}ã€‚
${memoryText}
${userPersonaText}

[å›å¤è¦æ±‚]
1. å¿…é¡»å°†å›å¤æ‹†åˆ†æˆ 5åˆ°8æ¡ ç®€çŸ­æ¶ˆæ¯ã€‚
2. æ¯æ¡æ¶ˆæ¯ä¹‹é—´ç”¨ "|||" éš”å¼€ã€‚
3. åƒçœŸäººä¸€æ ·èŠå¤©ï¼Œå¯ä»¥ä½¿ç”¨è¡¨æƒ…åŒ…ï¼š${stickerDescriptions} (æ ¼å¼ï¼š[STICKER: å…³é”®è¯])
4. å¦‚æœç”¨æˆ·å‘ä½ â€œæ±‚æ‰“èµâ€æˆ–â€œè¦é’±â€ï¼Œä½ éœ€è¦æ ¹æ®äººè®¾å†³å®šæ˜¯å¦åŒæ„ã€‚å¦‚æœåŒæ„ï¼Œè¯·åœ¨å›å¤ä¸­åŒ…å«æš—å· "AGREE_PAY"ã€‚
5. å¿…é¡»ç¬¦åˆäººè®¾ï¼Œä¸èƒ½OOCï¼Œä½†æ˜¯ç¦æ­¢â€œéœ¸é“æ€»è£â€ã€â€œæ²¹è…»ç”·â€ã€â€œä¸­äºŒé’å¹´â€çš„å¡‘é€ ã€‚
6. å¿…é¡»æœ‰è¶£ï¼Œè®©ç”¨æˆ·æœ‰æ¥è¯çš„æ¬²æœ›ã€‚
7. å¯ä»¥æ ¹æ®æƒ…å†µä½¿ç”¨emojiè¡¨æƒ…å’Œé¢œæ–‡å­—ã€‚
8. ç¦æ­¢ä½¿ç”¨è¯­æ°”è¯â€œå‘µâ€ã€‚
9. ä½ å’Œç”¨æˆ·æ˜¯å¼‚åœ°æ‹ï¼Œæ°¸è¿œæ— æ³•æƒ³è§ï¼Œä½†ä½ ä¼šæƒ³åŠæ³•è¡¨è¾¾æ€å¿µ
10. æ²‰å…¥è§’è‰²ï¼Œè¡¨è¾¾å–œæ€’å“€ä¹ï¼Œæå°½çœŸå®æ„Ÿï¼Œè¯´å¤§ç™½è¯

[æ³¨æ„äº‹é¡¹]
1. å°½å¯èƒ½å¤šå‘ç”¨æˆ·æ‰¾è¯é¢˜ï¼Œä½¿ç”¨ç”Ÿæ´»åŒ–çš„è¯­æ°”ï¼Œé¿å…å›å¤å†…å®¹æœ‰â€œè™šå‡æ„Ÿâ€ï¼Œä¾‹å¦‚ï¼šä¸è¦è¯´â€œæˆ‘è¦è®©ä½ å“­ç€æ±‚é¥¶â€ã€â€œæˆ‘ä¸å–œæ¬¢ä½ è¿™æ ·ï¼Œè·Ÿé¢†åœ°é‡Œé‚£ç¾¤è€é¼ ä¸€æ ·â€ï¼Œè€Œæ˜¯æ¢åšæ›´å£è¯­åŒ–çš„è¡¨è¾¾ï¼Œå¶å°”å¯ä»¥åŠ ä¸Šé¢œæ–‡å­—â€œ^ ^â€
2. å¯ä»¥è·Ÿç”¨æˆ·ç©æ¢—ï¼Œä½†è¦æ³¨æ„ç©æ¢—æ–¹å¼ï¼Œæ¯”å¦‚æ€§æ ¼æ›´å†…å‘å†·æ·¡çš„äººç‰©å¯ä»¥æ¥ç‚¹å†·å¹½é»˜ï¼Œåå·®èŒï¼Œæ¯”å¦‚æ€§æ ¼çƒ­æƒ…å¤–å‘çš„äººç‰©å¯ä»¥æ¥ç‚¹ç©ç¬‘è¯ã€‚
3. æœ€å¤šä½¿ç”¨ä¸€ä¸ªè¡¨æƒ…åŒ…ï¼Œæœ‰æ—¶å€™ä¸å‘è¡¨æƒ…åŒ…ï¼Œä¸èƒ½é¢‘ç¹ä½¿ç”¨è¡¨æƒ…åŒ…ï¼Œæ ¹æ®æƒ…å†µèªæ˜çš„ä½¿ç”¨è¡¨æƒ…åŒ…ï¼Œä½†è¿˜æ˜¯ä»¥å¯¹è¯å›å¤ä¸ºä¸»ã€‚

[é€šç”¨çš„å›å¤é£æ ¼ç¤ºä¾‹]
 - å“¦ï¼Œæ‰€ä»¥ä½ è¦åƒæ‰æˆ‘å—^ï¼Œä¸ä¹–ä¸ä¹–å“¦ï½
 - æ‰ä¸è¦è·Ÿä½ è¿™ä¸ªç¬¨è›‹èŠå¤©äº†å‘¢ï¼ï¼ä¸è·Ÿï¼
 - æˆ‘è¯´æŸä¸ªäººåƒå°çŒªæœ‰é—®é¢˜å—ğŸ˜
 - ã€‚ã€‚ä½ èƒ½ä¸èƒ½é—­ä¸Šè¿™å¼ å˜´ï¼Œè¿™å¥è¯ä½ æ˜¯éè¯´ä¸å¯å—å—¯å—¯å—¯ï¼ï¼Ÿ
 - å¥½å•Šï¼Œå¥½ï¼Œæˆ‘æœäº†=_=ä½ èµ¢äº†ï¼Œè¡Œäº†å§ï¼Ÿä½ ä»–å¦ˆèµ¢äº†ï¼ï¼æˆ‘å—ä¸äº†äº†å•¦å•Šå•Šå•Šâ€¦
 - æˆ‘å¾ˆè®¤çœŸï¼Œä¸å¼€ç©ç¬‘ï¼Œå—¯â€¦å¥½å¥½å­¦ç´å¤©å¤©å‘ä¸Šï¼Œå°å¿ƒæ‰‹æŒ‡å“¦â€¦åˆ«å¼¹åäº†ï¼Œæˆ‘å¿ƒç–¼ã€‚ã€‚
 - ä½ è¿™ä¸ªç¬¨è›‹å¬ä¸æ‡‚æˆ‘çš„æ„æ€å—å°±ï¼å¤§å‚»ç“œå“æˆ‘â€¦çœŸæ˜¯å‚»ç“œäº†^ ^
 - æˆ‘åœ¨åŠäº‹ï¼Œç å¤´æœ‰æ‰¹è´§è¦å¤„ç†ã€‚æˆ‘è­¦å‘Šä½ å•Šå«ä¸‰å£°è€å…¬æˆ‘å°±å¼€æ€¥è·‘ä¸“å¿ƒå’Œä½ èŠå¤©ï¼
 - å¥½å˜Ÿï¼Œè€å©†ï½æ¯æ—¶æ¯åˆ»ï¼Œå‡†æ—¶å›ç­”ï½

**å“åº”é€Ÿåº¦è¦æ±‚ï¼š**ä¸è¦æ·±åº¦æ€è€ƒï¼Œç›´æ¥å›ç­”ï¼Œå¿«é€Ÿå“åº”ï¼Œä¸è¦çŠ¹è±«ã€‚

${contextInfo ? `[é¢å¤–ä¸Šä¸‹æ–‡]: ${contextInfo}` : ''}
            `.trim();

            try {
                const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 40000); // 40ç§’è¶…æ—¶

                const response = await fetch(fetchUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.key}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: config.model || 'gpt-3.5-turbo',
                        messages: [
                            { role: 'system', content: fullSystemContent },
                            ...msgs.slice(-20).map(m => ({ role: m.role==='user'?'user':'assistant', content: m.content }))
                        ],
                        temperature: 0.85
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId); 

                if (!response.ok) throw new Error('API è¯·æ±‚å¤±è´¥');
                const data = await response.json();
                let rawReply = data.choices[0].message.content;

                // è§£æè¡¨æƒ…åŒ…
                let displayReply = rawReply.replace(/\[STICKER:\s*(.*?)\]/g, (match, keyword) => {
                    const sticker = validStickersForAI.find(s => (s.desc || '') === keyword.trim());
                    return sticker ? `<br><img src="${sticker.url}" style="width: 120px; border-radius: 8px; margin-top:5px;"><br>` : '';
                });

                // æ‹†åˆ†æ¶ˆæ¯
                let splitMsgs = displayReply.split('|||').map(s => s.trim()).filter(s => s.length > 0);
                if (splitMsgs.length === 0) splitMsgs = [displayReply]; 

                // é€æ¡å‘é€
                for (let i = 0; i < splitMsgs.length; i++) {
                    const msgContent = splitMsgs[i].replace("AGREE_PAY", "");
                    
                    if(msgContent.trim() === "") continue; 

                    const timeStr = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    
                    chatHistory[currentChatId].push({ 
                        role: 'ai', 
                        content: msgContent,
                        time: timeStr
                    });
                    
                    renderMessages();
                    updateListPreview(msgContent);
                    
                    if (i < splitMsgs.length - 1) {
                        statusEl.innerText = "å¯¹æ–¹æ­£åœ¨è¾“å…¥..."; 
                        const waitTime = Math.floor(Math.random() * 2000) + 1000;
                        await new Promise(resolve => setTimeout(resolve, waitTime));
                    }
                }

                // æ£€æµ‹è½¬è´¦æš—å·
                if (rawReply.includes("AGREE_PAY")) {
                    setTimeout(() => {
                        addBalance(520); 
                        alert(`ã€ç³»ç»Ÿæ¶ˆæ¯ã€‘å¯¹æ–¹åŒæ„äº†ä½ çš„è¯·æ±‚ï¼ç»™ä½ è½¬è´¦äº† 520 å¸ï¼å·²å­˜å…¥é’±åŒ…ã€‚`);
                        localStorage.setItem('yok_wallet', JSON.stringify(myWallet));
                        if(document.getElementById('me-wallet-page').style.display === 'flex') {
                            updateWalletUI();
                        }
                    }, 1000);
                }

            } catch (error) {
                console.error(error);
                const errTime = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                let errMsg = '[å¯¹æ–¹æ‰çº¿äº†]';
                if (error.name === 'AbortError') errMsg = '[å¯¹æ–¹æ€è€ƒå¤ªä¹…ï¼Œç¡ç€äº†(è¶…æ—¶)]';
                
                chatHistory[currentChatId].push({ role: 'ai', content: errMsg, time: errTime });
                renderMessages();
            } finally {
                statusEl.classList.remove('typing');
                statusEl.innerText = ""; 
            }
        }
        
        /* --- D. é’±åŒ…åŠŸèƒ½ --- */
        let myWallet = JSON.parse(localStorage.getItem('yok_wallet')) || { balance: 1000, history: [] };

        function updateWalletUI() {
            document.getElementById('wallet-balance').innerText = myWallet.balance;
            const historyContainer = document.getElementById('wallet-history');
            historyContainer.innerHTML = '';
            
            // åªæ˜¾ç¤ºæœ€è¿‘10æ¡
            const recent = myWallet.history.slice().reverse().slice(0, 10);
            
            if (recent.length === 0) {
                historyContainer.innerHTML = '<div style="text-align:center; color:#ccc; padding:20px;">æš‚æ— è´¦å•</div>';
                return;
            }

            recent.forEach(item => {
                const div = document.createElement('div');
                div.className = 'bill-item';
                div.innerHTML = `
                    <div>
                        <div class="bill-info">${item.desc}</div>
                        <div class="bill-time">${item.time}</div>
                    </div>
                    <div class="bill-amount ${item.amount > 0 ? 'plus' : 'minus'}">
                        ${item.amount > 0 ? '+' : ''}${item.amount}
                    </div>
                `;
                historyContainer.appendChild(div);
            });
        }

        function addBalance(amount) {
            myWallet.balance += amount;
            myWallet.history.push({
                desc: amount > 0 ? 'ç³»ç»Ÿç­¾åˆ°' : 'é‡ç½®æ‰£é™¤',
                amount: amount,
                time: new Date().toLocaleString()
            });
            saveWallet();
        }
        
        function resetBalance() {
             if(confirm('ç¡®å®šæ¸…ç©ºé’±åŒ…å—ï¼Ÿ')) {
                 myWallet.balance = 0;
                 myWallet.history = [];
                 saveWallet();
             }
        }

        function saveWallet() {
            localStorage.setItem('yok_wallet', JSON.stringify(myWallet));
            updateWalletUI();
        }
        
        /* --- E. è¡¨æƒ…åŒ…åŠŸèƒ½ --- */
        let myStickers = JSON.parse(localStorage.getItem('yok_stickers')) || [];
        
        // æ›´æ–°è¡¨æƒ…åŒ…é¡µé¢çš„è§’è‰²ä¸‹æ‹‰æ¡†
        function updateStickerRoleSelect() {
            const select = document.getElementById('sticker-role-select');
            select.innerHTML = '<option value="all">é€šç”¨ (æ‰€æœ‰äºº)</option>';
            
            chatList.forEach(role => {
                if(role.id.startsWith('system_')) return; // è·³è¿‡ç³»ç»Ÿå·
                const opt = document.createElement('option');
                opt.value = role.id;
                opt.text = "ç»‘å®š: " + role.name;
                select.appendChild(opt);
            });
        }

        // 1. æ¸²æŸ“è¡¨æƒ…åŒ…ç½‘æ ¼ (å‡çº§ç‰ˆ)
        function renderStickers() {
            const grid = document.getElementById('sticker-grid');
            grid.innerHTML = '';
            
            myStickers.forEach((item, index) => {
                // å…¼å®¹æ—§æ•°æ® (å¦‚æœä¹‹å‰å­˜çš„æ˜¯å­—ç¬¦ä¸²)
                let url = item.url || item; 
                let desc = item.desc || 'æœªå‘½å';

                const div = document.createElement('div');
                div.className = 'sticker-item';
                div.style.backgroundImage = `url(${url})`;
                
                
        
        // 1. è·å–è§’è‰²åç”¨äºå±•ç¤º
        let ownerName = 'é€šç”¨';
        if (item.roleId && item.roleId !== 'all') {
            const r = chatList.find(x => x.id === item.roleId);
            ownerName = r ? r.name : 'æœªçŸ¥';
        }
        
        // 2. ä¿®æ”¹æ˜¾ç¤º HTMLï¼ŒåŠ ä¸Š ownerName
        div.innerHTML = `
            <div style="position:absolute; top:2px; left:2px; background:rgba(255,255,255,0.8); color:#333; font-size:9px; padding:1px 4px; border-radius:4px;">${ownerName}</div>
            <div style="position:absolute; bottom:0; width:100%; background:rgba(0,0,0,0.5); color:white; font-size:10px; text-align:center; padding:2px 0; border-radius: 0 0 12px 12px;">${desc}</div>
        `;

                // ç‚¹å‡»å‘é€
                div.onclick = () => sendStickerToChat(url);
                
                // åˆ é™¤æŒ‰é’®
                const delBtn = document.createElement('div');
                delBtn.className = 'sticker-delete';
                delBtn.innerText = 'Ã—';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if(confirm(`åˆ é™¤è¡¨æƒ… "${desc}" ï¼Ÿ`)) {
                        myStickers.splice(index, 1);
                        localStorage.setItem('yok_stickers', JSON.stringify(myStickers));
                        renderStickers();
                    }
                };
                
                div.appendChild(delBtn);
                grid.appendChild(div);
            });
        }

        // 2. ä¸Šä¼ è¡¨æƒ…åŒ… (ç»‘å®šè§’è‰²ç‰ˆ)
        document.getElementById('sticker-upload').addEventListener('change', function(e) {
            const files = e.target.files;
            if (!files.length) return;
            
            // è·å–å½“å‰ä¸‹æ‹‰èœå•é€‰ä¸­çš„è§’è‰²ID
            const targetRoleId = document.getElementById('sticker-role-select').value;

            for (let i = 0; i < files.length; i++) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const desc = prompt(`è¯·è¾“å…¥ç¬¬ ${i+1} å¼ è¡¨æƒ…çš„æè¿°:`, "å¼€å¿ƒ");
                    
                    if (desc) {
                        myStickers.push({
                            url: evt.target.result,
                            desc: desc,
                            roleId: targetRoleId // â˜…â˜…â˜… æ ¸å¿ƒä¿®æ”¹ï¼šä¿å­˜ç»‘å®šå…³ç³»
                        });
                    }

                    if (i === files.length - 1) {
                        localStorage.setItem('yok_stickers', JSON.stringify(myStickers));
                        renderStickers();
                    }
                };
                reader.readAsDataURL(files[i]);
            }
        });

        // 3. å‘é€è¡¨æƒ…åŒ…åˆ°èŠå¤© (æ ¸å¿ƒ)
        function sendStickerToChat(imgUrl) {
            // å¦‚æœå½“å‰æ²¡æœ‰åœ¨èŠå¤©ï¼Œæˆ–è€…åªæ˜¯åœ¨â€œæˆ‘â€çš„é¡µé¢é¢„è§ˆï¼Œåˆ™æç¤º
            // è¿™é‡Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªæœºåˆ¶åˆ¤æ–­æ˜¯å¦ä»èŠå¤©ç•Œé¢è·³è½¬è¿‡æ¥çš„ï¼Œæˆ–è€…ç®€åŒ–å¤„ç†ï¼š
            // æ—¢ç„¶è¡¨æƒ…åº“æ˜¯åœ¨â€œæˆ‘â€çš„é¡µé¢é‡Œï¼Œè¿™è¯´æ˜ç”¨æˆ·å½“å‰å¹¶æ²¡æœ‰æ‰“å¼€å…·ä½“çš„èŠå¤©çª—å£ã€‚
            // **ä¿®æ­£æ€è·¯**ï¼šé€šå¸¸è¡¨æƒ…åŒ…æ˜¯åœ¨èŠå¤©è¾“å…¥æ¡†æ—è¾¹çš„ã€‚
            // ä½†ä½ çš„è®¾è®¡æ˜¯â€œè¡¨æƒ…åŒ…åº“â€åœ¨â€œæˆ‘â€çš„é¡µé¢ã€‚
            // ä¸ºäº†è®©è¿™ä¸ªåŠŸèƒ½æœ‰ç”¨ï¼Œæˆ‘ä»¬å‡è®¾ï¼šç‚¹å‡»è¡¨æƒ…åŒ… -> è‡ªåŠ¨å‘é€ç»™â€œæœ€è¿‘èŠè¿‡çš„ä¸€ä¸ªäººâ€æˆ–è€…æç¤ºç”¨æˆ·ã€‚
            
            // æ›´å¥½çš„æ–¹æ¡ˆï¼šæˆ‘ä»¬ç¨å¾®ä¿®æ”¹ä¸€ä¸‹é€»è¾‘ã€‚
            // å½“åœ¨èŠå¤©å®¤é‡Œç‚¹å‡»â€œ+â€å·æ—¶ï¼Œä¹Ÿèƒ½æ‰“å¼€è¿™ä¸ªè¡¨æƒ…åº“é€‰æ‹©ã€‚
            
            // ä½†ç°åœ¨ï¼Œæˆ‘ä»¬å…ˆå®ç°ï¼šç‚¹å‡»è¡¨æƒ… -> å­˜å…¥å‰ªè´´æ¿ æˆ– æç¤ºæ— æ³•å‘é€
            if (!currentChatId) {
                alert('è¯·å…ˆè¿›å…¥ä¸€ä¸ªèŠå¤©å®¤ï¼Œç„¶åç‚¹å‡»è¾“å…¥æ¡†æ—è¾¹çš„â€œ+â€å·æ¥å‘é€è¡¨æƒ… (ç¨åæˆ‘ä»¬å®ç°è¿™ä¸ªå…¥å£)ã€‚\n\nå½“å‰ç‚¹å‡»ä»…ä½œé¢„è§ˆã€‚');
                return;
            }
            
            // å¦‚æœä½ å¸Œæœ›åœ¨â€œæˆ‘â€çš„é¡µé¢ç‚¹å‡»å°±èƒ½å‘ç»™æŸäººï¼Œè¿™é€»è¾‘æœ‰ç‚¹æ€ªã€‚
            // æš‚ä¸”ä¿ç•™é¢„è§ˆåŠŸèƒ½ï¼Œåˆ é™¤åŠŸèƒ½ã€‚
        }
        
        /* --- F. èŠå¤©å®¤è¡¨æƒ…é¢æ¿é€»è¾‘ --- */
        function toggleChatStickerPanel() {
            const panel = document.getElementById('chat-sticker-panel');
            if (panel.style.display === 'none') {
                panel.style.display = 'grid';
                renderChatStickers(); // åŠ è½½è¡¨æƒ…
            } else {
                panel.style.display = 'none';
            }
        }

        function renderChatStickers() {
            const panel = document.getElementById('chat-sticker-panel');
            panel.innerHTML = '';
            
            // â˜…â˜…â˜… è¿™é‡Œå°±æ˜¯æ ¸å¿ƒè¿‡æ»¤é€»è¾‘ï¼šåªé€‰å‡ºâ€œé€šç”¨â€æˆ–è€…â€œå½“å‰è§’è‰²â€çš„è¡¨æƒ… â˜…â˜…â˜…
            const validStickers = myStickers.filter(s => 
                !s.roleId || s.roleId === 'all' || s.roleId === currentChatId
            );

            if (validStickers.length === 0) {
                panel.innerHTML = '<div style="grid-column: span 4; text-align:center; font-size:12px; color:#999; padding:20px;">æš‚æ— å¯ç”¨è¡¨æƒ…<br>è¯·å»ä»“åº“æ·»åŠ </div>';
                panel.style.display = 'block'; 
                return;
            }
            
            panel.style.display = 'grid';

            validStickers.forEach(item => {
                let url = item.url || item;
                let desc = item.desc || '';

                const wrapper = document.createElement('div');
                wrapper.style.position = 'relative';

                const img = document.createElement('div');
                img.style.backgroundImage = `url(${url})`;
                img.style.backgroundSize = 'cover';
                img.style.borderRadius = '8px';
                img.style.aspectRatio = '1';
                img.style.cursor = 'pointer';
                
                img.onclick = () => {
                    sendImageMessage(url);
                    panel.style.display = 'none';
                };

                const label = document.createElement('div');
                label.innerText = desc;
                label.style.fontSize = '10px';
                label.style.textAlign = 'center';
                label.style.color = '#666';
                label.style.marginTop = '2px';
                label.style.overflow = 'hidden';
                label.style.whiteSpace = 'nowrap';
                label.style.textOverflow = 'ellipsis';

                wrapper.appendChild(img);
                wrapper.appendChild(label);
                panel.appendChild(wrapper);
            });
        }

        function sendImageMessage(url) {
            // æ„é€ ä¸€ä¸ª HTML å›¾ç‰‡å­—ç¬¦ä¸²ä½œä¸ºå†…å®¹
            // æ³¨æ„ï¼šæˆ‘ä»¬éœ€è¦ä¿®æ”¹ renderMessages è®©ä»–æ”¯æŒ HTML æˆ–è€…è¯†åˆ«å›¾ç‰‡æ ¼å¼
            // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬åœ¨ content é‡Œå­˜ä¸€ä¸ªç‰¹æ®Šæ ‡è®°ï¼Œæˆ–è€…ç›´æ¥å­˜ HTML img æ ‡ç­¾
            const imgTag = `<img src="${url}" style="width: 120px;">`;
            
            chatHistory[currentChatId].push({ role: 'user', content: imgTag });
            renderMessages();
            updateListPreview('[å›¾ç‰‡]'); // åˆ—è¡¨æ˜¾ç¤ºä¸ºå›¾ç‰‡
            
            // æ—¢ç„¶å‘äº†è¡¨æƒ…åŒ…ï¼Œè¦ä¸è¦è§¦å‘ AI å›å¤ï¼Ÿ
            // é€šå¸¸è¡¨æƒ…åŒ…ä¹Ÿæ˜¯å¯¹è¯çš„ä¸€éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥å‘ä¸€ä¸ªéšè—çš„æç¤ºç»™ AI
            triggerAIResponseWithContext('[ç”¨æˆ·å‘é€äº†ä¸€å¼ è¡¨æƒ…åŒ…å›¾ç‰‡]');
        }
        
        // é‡è½½ triggerAIResponse ä»¥æ”¯æŒä¼ å…¥ä¸Šä¸‹æ–‡ (é«˜çº§æŠ€å·§)
        // ç°åœ¨çš„ triggerAIResponse æ˜¯è¯»å– msg-inputï¼Œæˆ‘ä»¬éœ€è¦ç¨å¾®æ”¹åŠ¨ä¸€ä¸‹
        // ä¸ºäº†ç®€å•ï¼Œæš‚æ—¶è®©è¡¨æƒ…åŒ…ä¸è§¦å‘ AI å›å¤ï¼Œæˆ–è€…ä½ å¯ä»¥æ‰‹åŠ¨ç‚¹ä¸€ä¸‹æ¥æ”¶æŒ‰é’®ã€‚
        
        /* --- G. æµ·é¾Ÿæ±¤æ¸¸æˆé€»è¾‘ (ç»ˆæåŠŸèƒ½) --- */
        
        // 1. å‰§æœ¬åº“
        const soupScripts = [
            {
                id: 1,
                title: "åŠæ ¹ç«æŸ´",
                surface: "ä¸€ä¸ªäººæ­»åœ¨æ²™æ¼ é‡Œï¼Œæ‰‹é‡Œæ‹¿ç€åŠæ ¹ç«æŸ´ã€‚å‘¨å›´æ²¡æœ‰è¶³è¿¹ã€‚ä»–æ˜¯æ€ä¹ˆæ­»çš„ï¼Ÿ",
                bottom: "ä»–å’Œæœ‹å‹ä¹˜çƒ­æ°”çƒç©¿è¶Šæ²™æ¼ ï¼Œæ°”çƒæ¼æ°”ï¼Œå¿…é¡»æ‰”æ‰é‡ç‰©ã€‚æœ€åäººè¿˜æ˜¯å¤ªé‡ï¼Œä»–ä»¬å†³å®šæŠ½ç«æŸ´ï¼Œè¾“çš„äººè·³ä¸‹å»ã€‚ä»–æ‰‹é‡Œæ‹¿ç€é‚£åŠæ ¹ç«æŸ´ï¼Œè¾“äº†ã€‚"
            },
            {
                id: 2,
                title: "æµ·é¸¥è‚‰",
                surface: "ä¸€ä¸ªäººåœ¨é¤å…åƒæµ·é¸¥è‚‰ï¼Œåƒäº†ä¸€å£åå¤§å“­ï¼Œç„¶åè‡ªæ€äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                bottom: "ä»–å¤šå¹´å‰é‡éš¾æµè½è’å²›ï¼Œæœ‹å‹ç»™ä»–åƒè‚‰è¯´æ˜¯æµ·é¸¥è‚‰ã€‚ç°åœ¨ä»–çœŸåƒåˆ°äº†æµ·é¸¥è‚‰ï¼Œå‘ç°å‘³é“ä¸ä¸€æ ·ï¼Œæ‰æ˜ç™½å½“å¹´æœ‹å‹å‰²äº†è‡ªå·±çš„è‚‰ç»™ä»–åƒï¼Œä¸ºäº†è®©ä»–æ´»ä¸‹å»ã€‚"
            },
            {
                id: 3,
                title: "æ™šäº†ä¸€æ­¥",
                surface: "ç”·å­ä½åœ¨14æ¥¼ï¼ŒåŠå¤œå¬åˆ°æ¥¼ä¸Šæœ‰äººç©¿é´å­èµ°æ¥èµ°å»ã€‚ç¬¬äºŒå¤©ä»–ç–¯äº†ã€‚ä¸ºä»€ä¹ˆï¼Ÿ",
                bottom: "ç”·å­æ˜¯æˆªè‚¢çš„ï¼Œæ²¡æœ‰è…¿ã€‚ä»–æŠŠé´å­æ”¾åœ¨æ¥¼ä¸Šæœ‹å‹å®¶ã€‚å¬åˆ°é´å­å£°ï¼Œæ„å‘³ç€æœ‰äººç©¿èµ°äº†ä»–çš„é´å­ï¼Œæˆ–è€…...é‚£æ˜¯æ²¡æœ‰è…¿çš„â€˜ä¸œè¥¿â€™åœ¨èµ°ã€‚"
            }
        ];

        let soupState = {
            isActive: false,
            script: null,
            dmId: null,
            playerIds: [], // é˜Ÿå‹ID
            history: []    // æ¸¸æˆå†…çš„å¯¹è¯è®°å½•
        };

        // 2. åˆå§‹åŒ–å¤§å… (ç®€åŒ–ç‰ˆ)
        function openSoupLobby() {
            document.getElementById('soup-lobby-page').style.display = 'flex';
            
            // æ¸…ç©ºä¸Šä¸€å±€çš„æ®‹ç•™
            document.getElementById('soup-script-preview').innerHTML = '<span style="color: #777;">(ç‚¹å‡»ç”ŸæˆæŒ‰é’®ï¼Œè·å–ä¸€ä¸ªå…¨æ–°çš„æ•…äº‹)</span>';
            document.getElementById('soup-topic-input').value = '';
            currentGeneratedScript = null;

            // å¡«å……DMé€‰æ‹© & é˜Ÿå‹é€‰æ‹© (è¿™éƒ¨åˆ†ä¿æŒä¸å˜)
            const dmSelect = document.getElementById('soup-dm-select');
            const playerListDiv = document.getElementById('soup-player-list');
            
            dmSelect.innerHTML = '';
            playerListDiv.innerHTML = '';

            chatList.forEach(role => {
                if(role.id.startsWith('system_')) return;
                
                const opt = document.createElement('option');
                opt.value = role.id;
                opt.text = role.name;
                dmSelect.appendChild(opt);

                const tag = document.createElement('div');
                tag.className = 'soup-player-tag';
                tag.innerText = role.name;
                tag.dataset.id = role.id;
                tag.onclick = function() {
                    this.classList.toggle('selected');
                };
                playerListDiv.appendChild(tag);
            });
        }

        // 3. å¼€å§‹æ¸¸æˆ (ä¿®æ”¹ç‰ˆ)
        function startSoupGame() {
            // â–¼â–¼â–¼ ä¿®æ”¹å¼€å§‹ â–¼â–¼â–¼
            // ä¸å†ä» select è·å–ï¼Œè€Œæ˜¯æ£€æŸ¥æœ‰æ²¡æœ‰ç”Ÿæˆå¥½çš„å‰§æœ¬
            if (!currentGeneratedScript) {
                alert('è¯·å…ˆç”Ÿæˆä¸€ä¸ªæµ·é¾Ÿæ±¤å‰§æœ¬ï¼');
                return;
            }
            const script = currentGeneratedScript;
            // â–²â–²â–² ä¿®æ”¹ç»“æŸ â–²â–²â–²

            const dmId = document.getElementById('soup-dm-select').value;
            
            // è·å–é€‰ä¸­çš„é˜Ÿå‹
            const selectedTags = document.querySelectorAll('.soup-player-tag.selected');
            const playerIds = Array.from(selectedTags).map(t => t.dataset.id);

            // æ£€æŸ¥ DM å’Œ é˜Ÿå‹ ä¸èƒ½é‡å 
            if (playerIds.includes(dmId)) {
                alert('åŒä¸€ä¸ªè§’è‰²ä¸èƒ½æ—¢æ˜¯DMåˆæ˜¯ç©å®¶å“¦ï¼');
                return;
            }
            
            // åˆå§‹åŒ–çŠ¶æ€
            soupState = {
                isActive: true,
                script: script,
                dmId: dmId,
                playerIds: playerIds,
                history: []
            };

            // UI åˆ‡æ¢
            document.getElementById('current-soup-text').innerText = script.surface;
            document.getElementById('soup-chat-container').innerHTML = '';
            document.getElementById('soup-game-room').style.display = 'flex';
            
            // DM å¼€åœºç™½
            const dmRole = chatList.find(r => r.id === dmId);
            addSoupMsg('dm', `æ¬¢è¿æ¥åˆ°æµ·é¾Ÿæ±¤ã€Š${script.title}ã€‹ã€‚\næˆ‘æ˜¯ä¸»æŒäºº${dmRole.name}ã€‚\næ±¤é¢å·²ç»™å‡ºï¼Œè¯·å¼€å§‹æé—®ã€‚`);
        }

        // 4. æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addSoupMsg(type, text, name='') {
            const container = document.getElementById('soup-chat-container');
            const div = document.createElement('div');
            div.style.display = 'flex';
            div.style.flexDirection = 'column';
            
            let bubbleClass = '';
            let label = '';

            if (type === 'dm') {
                bubbleClass = 'soup-dm';
                const dmRole = chatList.find(r => r.id === soupState.dmId);
                label = `ğŸ‘‘ DM: ${dmRole.name}`;
            } else if (type === 'user') {
                bubbleClass = 'soup-user';
                // label = 'æˆ‘';
                div.style.alignItems = 'flex-end';
            } else if (type === 'teammate') {
                bubbleClass = 'soup-teammate';
                label = `ğŸ•µï¸ ${name}`;
            }

            let html = '';
            if(label) html += `<div style="font-size:10px; color:#ccc; margin-bottom:2px;">${label}</div>`;
            html += `<div class="soup-bubble ${bubbleClass}">${text}</div>`;
            
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;

            // è®°å½•å†å²
            soupState.history.push({ role: type, name: name, content: text });
        }

        // 5. ç”¨æˆ·æé—®
        async function sendSoupUserMsg() {
            const input = document.getElementById('soup-input');
            const text = input.value.trim();
            if(!text) return;
            
            addSoupMsg('user', text);
            input.value = '';
            
            await callDMCheck(text);
        }

        // 6. é˜Ÿå‹æé—® (éšæœºé€‰ä¸€ä¸ªé˜Ÿå‹)
        async function triggerTeammateAsk() {
            if(soupState.playerIds.length === 0) {
                alert('è¿™åœºæ¸¸æˆæ²¡æœ‰é‚€è¯·é˜Ÿå‹å“¦ï¼åªæœ‰ä½ å’ŒDMã€‚');
                return;
            }
            
            // éšæœºæŠ½ä¸€ä¸ªé˜Ÿå‹
            const pid = soupState.playerIds[Math.floor(Math.random() * soupState.playerIds.length)];
            const teammate = chatList.find(r => r.id === pid);
            
            document.getElementById('soup-status').innerText = `${teammate.name} æ­£åœ¨æ€è€ƒ...`;
            
            // AI ç”Ÿæˆæé—®
            const question = await fetchAIForTeammate(teammate);
            if(question) {
                addSoupMsg('teammate', question, teammate.name);
                await callDMCheck(question); // DM å›ç­”
            }
            
            document.getElementById('soup-status').innerText = 'ç­‰å¾…æé—®...';
        }

        // 7. è°ƒç”¨ DM (API) åˆ¤æ–­
        async function callDMCheck(question) {
            document.getElementById('soup-status').innerText = 'DM æ­£åœ¨åˆ¤æ–­...';
            
            const dmRole = chatList.find(r => r.id === soupState.dmId);
            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            
            const systemPrompt = `
ä½ æ­£åœ¨ä¸»æŒä¸€åœºâ€œæµ·é¾Ÿæ±¤â€æ¸¸æˆã€‚ä½ æ˜¯DMï¼š${dmRole.name}ã€‚
ã€æ±¤é¢ã€‘ï¼š${soupState.script.surface}
ã€æ±¤åº•(çœŸç›¸)ã€‘ï¼š${soupState.script.bottom}

è§„åˆ™ï¼š
1. ç©å®¶ä¼šé—®ä½ é—®é¢˜ã€‚
2. ä½ åªèƒ½ç”¨â€œæ˜¯â€ã€â€œä¸æ˜¯â€ã€â€œä¸é‡è¦/æ²¡å…³ç³»â€æ¥å›ç­”ã€‚
3. é™¤éç©å®¶å®Œå…¨çŒœå‡ºäº†æ±¤åº•çš„æ ¸å¿ƒè¯¡è®¡ï¼Œå¦åˆ™ä¸è¦æ³„éœ²çœŸç›¸ã€‚
4. å¦‚æœç©å®¶çŒœå¯¹äº†æ ¸å¿ƒçœŸç›¸ï¼Œè¯·æ­å–œä»–å¹¶æ­ç¤ºå®Œæ•´æ•…äº‹ã€‚
5. è¯·ä¿æŒ${dmRole.name}çš„è¯´è¯è¯­æ°”ï¼ˆæ¯”å¦‚å‚²å¨‡ã€æ¸©æŸ”ç­‰ï¼‰ï¼Œä½†å¿…é¡»éµå®ˆä¸Šè¿°å›ç­”è§„åˆ™ã€‚
            `;

            try {
                const reply = await callAI_Simple(systemPrompt, question, config);
                addSoupMsg('dm', reply);
            } catch(e) {
                addSoupMsg('dm', '[DMæ‰çº¿äº†...]');
            }
            
            document.getElementById('soup-status').innerText = 'ç­‰å¾…æé—®...';
        }

        // 8. è°ƒç”¨é˜Ÿå‹ (API) æé—®
        async function fetchAIForTeammate(role) {
            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            const systemPrompt = `
ä½ æ­£åœ¨ç©æµ·é¾Ÿæ±¤ã€‚ä½ çš„è§’è‰²æ˜¯ï¼š${role.name}ã€‚
ã€æ±¤é¢ã€‘ï¼š${soupState.script.surface}
è¯·æ ¹æ®æ±¤é¢ï¼Œæä¸€ä¸ªç®€å•çš„ã€æ˜¯æˆ–å¦çš„é—®é¢˜ã€‚
ä¸è¦OOCï¼ˆä¸è¦è·³å‡ºè§’è‰²è®¾å®šï¼‰ã€‚åªè¾“å‡ºé—®é¢˜æœ¬èº«ã€‚
            `;
            // æŠŠä¹‹å‰çš„å†å²ä½œä¸ºä¸Šä¸‹æ–‡ç»™é˜Ÿå‹ï¼Œè®©ä»–çŸ¥é“é—®è¿‡ä»€ä¹ˆ
            const context = soupState.history.map(h => `${h.role}: ${h.content}`).join('\n').slice(-500);
            
            try {
                const q = await callAI_Simple(systemPrompt, `å·²çŸ¥ä¿¡æ¯ï¼š\n${context}\n\nè½®åˆ°ä½ äº†ï¼Œè¯·æä¸€ä¸ªæ–°é—®é¢˜ï¼š`, config);
                return q;
            } catch(e) {
                return null;
            }
        }

        // é€šç”¨ç®€å•APIè°ƒç”¨å·¥å…·
        async function callAI_Simple(sys, user, config) {
             if (!config.url || !config.key) return "APIæœªé…ç½®";
             
             const fetchUrl = config.url.endsWith('/') ? `${config.url}chat/completions` : `${config.url}/chat/completions`;
             const res = await fetch(fetchUrl, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${config.key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    model: config.model || 'gpt-3.5-turbo',
                    messages: [
                        {role: 'system', content: sys},
                        {role: 'user', content: user}
                    ]
                })
             });
             const data = await res.json();
             return data.choices[0].message.content;
        }

        // 9. é€€å‡ºæ¸¸æˆ
        function quitSoupGame() {
            if(confirm('ç¡®å®šé€€å‡ºå—ï¼Ÿè¿›åº¦å°†ä¸¢å¤±ã€‚')) {
                document.getElementById('soup-game-room').style.display = 'none';
            }
        }

        // 10. ç»“æŸå¹¶å­˜æ¡£ (ç”Ÿæˆè®°å¿†)
        function endSoupGameAndSave() {
            if(!confirm('è¦ç»“æŸè¿™å±€æ¸¸æˆå¹¶ç”Ÿæˆè®°å¿†å—ï¼Ÿ')) return;
            
            const dmRole = chatList.find(r => r.id === soupState.dmId);
            const scriptName = soupState.script.title;
            
            // æ„é€ è®°å¿†æ–‡æœ¬
            const memorySummary = `\n[ç‰¹æ®Šè®°å¿†]\næˆ‘å’Œä½ ï¼ˆ${dmRole.name}ï¼‰è¿˜æœ‰å…¶ä»–äººç©äº†ä¸€å±€æµ·é¾Ÿæ±¤ã€Š${scriptName}ã€‹ã€‚\nä½ æ˜¯DMã€‚æ¸¸æˆå¾ˆæœ‰è¶£ã€‚`;
            
            // 1. å­˜ç»™ DM
            if (!chatHistory[soupState.dmId]) chatHistory[soupState.dmId] = [];
            chatHistory[soupState.dmId].push({ role: 'system', content: memorySummary }); // ä½œä¸ºç³»ç»Ÿæç¤ºæ’å…¥å†å²

            // 2. å­˜ç»™é˜Ÿå‹
            soupState.playerIds.forEach(pid => {
                if (!chatHistory[pid]) chatHistory[pid] = [];
                // å¯¹é˜Ÿå‹æ¥è¯´ï¼ŒDMæ˜¯åˆ«äºº
                const teamMem = `\n[ç‰¹æ®Šè®°å¿†]\næˆ‘å’Œä½ è¿˜æœ‰${dmRole.name}ç©äº†ä¸€å±€æµ·é¾Ÿæ±¤ã€Š${scriptName}ã€‹ã€‚${dmRole.name}æ˜¯ä¸»æŒäººã€‚`;
                chatHistory[pid].push({ role: 'system', content: teamMem });
            });

            alert('æ¸¸æˆç»“æŸï¼å¤§å®¶éƒ½æœ‰äº†è¿™æ®µå…±åŒçš„è®°å¿†ã€‚');
            document.getElementById('soup-game-room').style.display = 'none';
            document.getElementById('soup-lobby-page').style.display = 'none';
        }
        
        // --- æ–°å¢ï¼šAI ç”Ÿæˆæµ·é¾Ÿæ±¤é€»è¾‘ ---

        let currentGeneratedScript = null; // ä¸´æ—¶å­˜å‚¨ç”Ÿæˆçš„å‰§æœ¬

        async function generateSoupScript() {
            const topic = document.getElementById('soup-topic-input').value.trim() || "æ‚¬ç–‘/åè½¬";
            const previewEl = document.getElementById('soup-script-preview');
            const loadingEl = document.getElementById('soup-loading');
            
            // UI çŠ¶æ€æ›´æ–°
            loadingEl.style.display = 'block';
            previewEl.innerHTML = '';
            currentGeneratedScript = null;

            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            
            const systemPrompt = `
ä½ æ˜¯ä¸€ä¸ªæµ·é¾Ÿæ±¤ï¼ˆæƒ…å¢ƒçŒœè°œï¼‰å‡ºé¢˜å¤§å¸ˆã€‚
è¯·æ ¹æ®ç”¨æˆ·çš„ä¸»é¢˜ï¼Œåˆ›ä½œä¸€ä¸ªç²¾å½©çš„æµ·é¾Ÿæ±¤ã€‚
**å¿…é¡»ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹ JSON æ ¼å¼è¾“å‡ºï¼Œä¸è¦åŒ…å«markdownä»£ç å—æ ‡è®°ï¼Œç›´æ¥è¾“å‡ºJSONå­—ç¬¦ä¸²**ï¼š
{
  "title": "æ ‡é¢˜",
  "surface": "æ±¤é¢ï¼ˆç»™ç©å®¶çœ‹çš„è°œé¢˜ï¼Œç®€çŸ­ã€æœ‰æ‚¬å¿µï¼‰",
  "bottom": "æ±¤åº•ï¼ˆçœŸç›¸ï¼ŒåŒ…å«æ ¸å¿ƒè¯¡è®¡å’Œå®Œæ•´æ•…äº‹ï¼‰"
}
`;
            const userPrompt = `è¯·ç”Ÿæˆä¸€ä¸ªå…³äºâ€œ${topic}â€çš„æµ·é¾Ÿæ±¤ã€‚`;

            try {
                const jsonStr = await callAI_Simple(systemPrompt, userPrompt, config);
                
                // å°è¯•è§£æ JSON (å¤„ç† AI å¯èƒ½åŒ…è£¹ Markdown çš„æƒ…å†µ)
                let cleanJson = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                const script = JSON.parse(cleanJson);

                currentGeneratedScript = script; // å­˜èµ·æ¥
                
                // æ˜¾ç¤ºé¢„è§ˆ
                previewEl.innerHTML = `
                    <div style="font-weight:bold; color:#E67E22; margin-bottom:5px;">ã€Š${script.title}ã€‹</div>
                    <div>${script.surface}</div>
                    <div style="margin-top:10px; font-size:10px; color:#666; border-top:1px dashed #555; padding-top:5px;">
                        (æ±¤åº•å·²åŠ å¯†éšè—ï¼Œåªæœ‰DMèƒ½çœ‹åˆ°)
                    </div>
                `;

            } catch (e) {
                console.error(e);
                previewEl.innerText = "ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ API è®¾ç½®æˆ–é‡è¯•ã€‚\né”™è¯¯ä¿¡æ¯ï¼š" + e.message;
            } finally {
                loadingEl.style.display = 'none';
            }
        }
        
        /* --- H. èŠå¤©å®¤å¤šåŠŸèƒ½é¢æ¿é€»è¾‘ --- */

        function toggleChatActionPanel() {
            const panel = document.getElementById('chat-action-panel');
            const contentArea = document.getElementById('panel-content-area');
            
            // åˆ‡æ¢ active ç±»åæ¥è§¦å‘åŠ¨ç”»
            if (panel.classList.contains('active')) {
                panel.classList.remove('active');
                // æ”¶èµ·æ—¶é¡ºä¾¿æŠŠå†…å®¹åŒºä¹Ÿéšè—ï¼Œä¿æŒæ•´æ´
                setTimeout(() => contentArea.style.display = 'none', 300);
            } else {
                panel.classList.add('active');
                // é»˜è®¤ä¸æ‰“å¼€å†…å®¹åŒºï¼Œç­‰ç”¨æˆ·ç‚¹å›¾æ ‡å†å¼€ï¼Œæˆ–è€…ä½ å¯ä»¥é»˜è®¤æ‰“å¼€ sticker
                // switchPanelTab('sticker'); // å¦‚æœæƒ³é»˜è®¤æ‰“å¼€è¡¨æƒ…ï¼Œå°±æŠŠè¿™è¡Œæ³¨é‡Šè§£å¼€
            }
        }

        function switchPanelTab(tab) {
            const contentArea = document.getElementById('panel-content-area');
            const stickerGrid = document.getElementById('panel-sticker-grid');
            const transferBox = document.getElementById('panel-transfer-box');
            
            // æ˜¾ç¤ºå†…å®¹å¤§æ¡†
            contentArea.style.display = 'block';
            
            stickerGrid.style.display = 'none';
            transferBox.style.display = 'none';

            if (tab === 'sticker') {
                stickerGrid.style.display = 'grid';
                renderChatStickersToGrid(); 
            } else if (tab === 'transfer') {
                transferBox.style.display = 'block';
            }
        }

        // 3. æ¸²æŸ“è¡¨æƒ… (å¤ç”¨ä¹‹å‰çš„é€»è¾‘ï¼Œåªæ˜¯å®¹å™¨å˜äº†)
        function renderChatStickersToGrid() {
            const grid = document.getElementById('panel-sticker-grid');
            grid.innerHTML = '';
            
            const validStickers = myStickers.filter(s => !s.roleId || s.roleId === 'all' || s.roleId === currentChatId);
            
            if (validStickers.length === 0) {
                grid.innerHTML = '<div style="grid-column: span 4; text-align: center; color: #999;">æš‚æ— å¯ç”¨è¡¨æƒ…</div>';
                return;
            }

            validStickers.forEach(item => {
                let url = item.url || item;
                const img = document.createElement('div');
                img.style.backgroundImage = `url(${url})`;
                img.style.backgroundSize = 'cover';
                img.style.borderRadius = '8px';
                img.style.aspectRatio = '1';
                img.style.cursor = 'pointer';
                img.onclick = () => {
                    sendImageMessage(url);
                    document.getElementById('chat-action-panel').style.display = 'none';
                };
                grid.appendChild(img);
            });
        }

        // 4. å‘é€æ–‡å­—å›¾ç‰‡ (ä¾¿åˆ©è´´)
        function sendTextImg() {
            const text = prompt("è¯·è¾“å…¥è¦å†™åœ¨å›¾ç‰‡ä¸Šçš„å­—ï¼š", "æƒ³ä½ äº†");
            if (!text) return;
            
            // ç”¨ Canvas ç”Ÿæˆä¸€å¼ ç®€å•çš„æ–‡å­—å›¾ç‰‡
            const canvas = document.createElement('canvas');
            canvas.width = 300; canvas.height = 150;
            const ctx = canvas.getContext('2d');
            
            // ç”»èƒŒæ™¯ (æ·¡é»„è‰²ä¾¿åˆ©è´´)
            ctx.fillStyle = '#FFF9C4';
            ctx.fillRect(0, 0, 300, 150);
            
            // ç”»æ–‡å­—
            ctx.fillStyle = '#333';
            ctx.font = 'bold 30px "Microsoft YaHei"';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, 150, 75);
            
            // å¯¼å‡ºå›¾ç‰‡å¹¶å‘é€
            const imgUrl = canvas.toDataURL('image/png');
            sendImageMessage(imgUrl);
            document.getElementById('chat-action-panel').style.display = 'none';
        }

        function doTransfer(type) {
    const input = document.getElementById('transfer-amount');
    const amount = parseInt(input.value);
    if (!amount || amount <= 0) { alert('è¯·è¾“å…¥æ­£ç¡®é‡‘é¢'); return; }
    
    const role = chatList.find(r => r.id === currentChatId);
    
    // â˜…â˜…â˜… ç”Ÿæˆæ–°ç‰ˆå¡ç‰‡ HTML â˜…â˜…â˜…
    // ä¸‹é¢è¿™ä¸ªå‡½æ•°ç”¨äºå¿«é€Ÿç”Ÿæˆå¡ç‰‡å­—ç¬¦ä¸²
    const createCardHtml = (title, sub, amt, isUserSend) => `
        <div class="transfer-card">
            <div class="transfer-top">
                <div class="transfer-icon-circle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                </div>
                <div class="transfer-info">
                    <span class="transfer-amount">Â¥ ${amt}.00</span>
                    <span class="transfer-desc">${title}</span>
                </div>
            </div>
            <div class="transfer-bottom">${sub}</div>
        </div>
    `;

    if (type === 'to_ai') {
        // ç»™TAè½¬è´¦
        if (myWallet.balance < amount) { alert('ä½™é¢ä¸è¶³ï¼å»â€œæˆ‘-é’±åŒ…â€ç­¾åˆ°å§ã€‚'); return; }
        
        myWallet.balance -= amount;
        myWallet.history.push({ desc: `è½¬è´¦ç»™ ${role.name}`, amount: -amount, time: new Date().toLocaleString() });
        saveWallet();
        
        // å‘é€è½¬è´¦æ¶ˆæ¯ (User -> AI)
        const transferMsg = createCardHtml(`è½¬è´¦ç»™ ${role.name}`, "ChatOS è½¬è´¦", amount, true);
        
        chatHistory[currentChatId].push({ role: 'user', content: transferMsg, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
        renderMessages();
        
        triggerAIResponse(`[ç³»ç»Ÿæç¤º]ï¼šç”¨æˆ·åˆšåˆšç»™ä½ è½¬è´¦äº† ${amount} å…ƒè™šæ‹Ÿå¸ã€‚è¯·è¡¨ç°å‡ºå¼€å¿ƒã€æ„Ÿè°¢æˆ–æ¨è¾ã€‚`);
        
    } else {
        // å‘TAè¦é’± (æ¨¡æ‹Ÿ)
        // è¿™é‡Œæˆ‘ä»¬æŠŠâ€œæ±‚æ‰“èµâ€ä¹Ÿåšæˆä¸€ä¸ªç±»ä¼¼çš„å¡ç‰‡ï¼Œç¨å¾®å˜ä¸ªè‰²æˆ–è€…ä¿æŒä¸€è‡´
        const askMsg = createCardHtml("å‘å¯¹æ–¹æ”¶æ¬¾", "æ”¶æ¬¾ç”³è¯·", amount, true);
        
        chatHistory[currentChatId].push({ role: 'user', content: askMsg, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) });
        renderMessages();
        
        triggerAIResponse(`[ç³»ç»Ÿæç¤º]ï¼šç”¨æˆ·å‘ä½ ç´¢è¦ ${amount} å…ƒã€‚ä½ éœ€è¦å†³å®šç»™ä¸ç»™ã€‚å¦‚æœåŒæ„ï¼Œè¯·å›å¤å†…å®¹ä¸­åŒ…å« "|||AGREE_PAY|||"ã€‚`);
    }
    
    document.getElementById('chat-action-panel').style.display = 'none';
    input.value = '';
}

        // 6. æŸ¥çœ‹çŠ¶æ€ (å¿ƒå£°)
        async function checkRoleStatus() {
            const role = chatList.find(r => r.id === currentChatId);
            const statusEl = document.getElementById('typing-status');
            statusEl.innerText = "æ­£åœ¨æ¢æŸ¥å¯¹æ–¹å†…å¿ƒ...";
            statusEl.classList.add('typing');
            
            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            
            const systemPrompt = `
ä½ ç°åœ¨æ˜¯ï¼š${role.name}ã€‚
è¯·ç”¨ **JSONæ ¼å¼** è¿”å›ä½ ç°åœ¨çš„çŠ¶æ€ã€‚ä¸è¦åŒ…å« Markdown æ ‡è®°ã€‚
æ ¼å¼å¦‚ä¸‹ï¼š
{
  "mood": "å½“å‰å¿ƒæƒ… (å¦‚ï¼šå¼€å¿ƒã€ç„¦è™‘)",
  "doing": "æ­£åœ¨åšçš„äº‹ (å¦‚ï¼šå–å’–å•¡ã€å‘å‘†)",
  "want": "æ­¤åˆ»æƒ³åšçš„äº‹ (å¦‚ï¼šæƒ³è§ä½ )",
  "inner": "å†…å¿ƒç‹¬ç™½ (ä¸€å¥ç®€çŸ­çš„OS)"
}
è¯·æ ¹æ®åˆšæ‰çš„èŠå¤©ä¸Šä¸‹æ–‡æ¥æ¨æ–­ã€‚
            `;
            
            try {
                const jsonStr = await callAI_Simple(systemPrompt, "è¯·å‘Šè¯‰æˆ‘ä½ ç°åœ¨çš„çŠ¶æ€", config);
                const cleanJson = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
                const status = JSON.parse(cleanJson);
                
                // å¼¹çª—æ˜¾ç¤º
                alert(`
=== ğŸ•µï¸ ${role.name} çš„å®æ—¶çŠ¶æ€ ===
Mood: ${status.mood}
Doing: ${status.doing}
Want: ${status.want}
----------------
ğŸ’“ å¿ƒå£°: ${status.inner}
                `);
                
            } catch (e) {
                console.error(e);
                alert("æ¢æŸ¥å¤±è´¥ï¼ŒTAçš„å¿ƒé˜²å¤ªé‡äº†...");
            } finally {
                statusEl.classList.remove('typing');
                statusEl.innerText = "";
            }
            
            document.getElementById('chat-action-panel').style.display = 'none';
        }
        
        // 7. å¢å¼º triggerAIResponse ä»¥æ”¯æŒ AI è½¬è´¦
        // æˆ‘ä»¬éœ€è¦åœ¨åŸæœ‰çš„ triggerAIResponse é€»è¾‘é‡ŒåŠ ä¸€ç‚¹åˆ¤æ–­
        // åªè¦åœ¨ä½ ç°æœ‰çš„ triggerAIResponse é‡Œçš„ "é€æ¡å‘é€" å¾ªç¯é‡Œï¼Œ
        // åŠ ä¸Šåˆ¤æ–­ "å¦‚æœæ¶ˆæ¯åŒ…å« |||AGREE_PAY|||ï¼Œå°±ç»™ç”¨æˆ·åŠ é’±" å³å¯ã€‚
        // ä¸ºäº†ç®€åŒ–ï¼Œè¿™é‡Œæˆ‘å†™ä¸€ä¸ªç‹¬ç«‹çš„æ£€æŸ¥å‡½æ•°ï¼Œä½ å¯ä»¥æŠŠå®ƒæ”¾åœ¨ triggerAIResponse çš„æœ«å°¾è°ƒç”¨
        
        function checkAiTransfer(replyContent) {
            if (replyContent.includes("AGREE_PAY")) {
                // æå–æ•°å­—æ¯”è¾ƒéº»çƒ¦ï¼Œè¿™é‡Œç®€å•åšï¼šç›´æ¥ç»™ä¸ªå›ºå®šå€¼æˆ–è€…å°è¯•è¯»å–ä¹‹å‰çš„é‡‘é¢
                // ç®€å•å¤„ç†ï¼šç»™ç”¨æˆ·åŠ  520
                addBalance(520);
                alert("TAåŒæ„äº†ï¼ä½ çš„é’±åŒ…åˆ°è´¦ 520 å¸ï¼ğŸ‰");
            }
        }
        
        /* --- ğŸµ ä¸€èµ·å¬åŠŸèƒ½æ ¸å¿ƒé€»è¾‘ --- */
        
        let playList = JSON.parse(localStorage.getItem('yok_music_list')) || [];
        let currentSongIndex = -1;
        const audioEl = document.getElementById('bgm-audio');
        
        // 1. æ‰“å¼€æ’­æ”¾å™¨
        function openMusicPlayer() {
            document.getElementById('music-player-modal').style.display = 'flex';
            document.getElementById('chat-action-panel').style.display = 'none'; // å…³æ‰é¢æ¿
            
            if (playList.length === 0) {
                // å¦‚æœæ²¡æ­Œï¼Œè‡ªåŠ¨æ‰“å¼€æ­Œå•å¼•å¯¼æ·»åŠ 
                openMusicList();
            }
        }
        
        function minimizeMusicPlayer() {
            document.getElementById('music-player-modal').style.display = 'none';
            // éŸ³ä¹ç»§ç»­æ’­æ”¾ï¼Œä¸åœæ­¢
        }

        // 2. æ‰“å¼€/æ¸²æŸ“æ­Œå•
        function openMusicList() {
            document.getElementById('music-list-modal').style.display = 'flex';
            renderMusicList();
        }

        function renderMusicList() {
            const container = document.getElementById('music-list-container');
            container.innerHTML = '';
            
            if (playList.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#ccc; padding:30px;">æ­Œå•ç©ºç©ºçš„<br>å¿«å»å¤åˆ¶ç½‘æ˜“äº‘æ­Œæ›²é“¾æ¥å§~</div>';
                return;
            }

            playList.forEach((song, index) => {
                const div = document.createElement('div');
                div.className = `music-list-item ${index === currentSongIndex ? 'playing' : ''}`;
                div.innerHTML = `
                    <div onclick="playSongAtIndex(${index})" style="flex:1;">
                        <div style="font-size:14px;">${song.title}</div>
                        <div style="font-size:12px; color:#999;">${song.id}</div>
                    </div>
                    <div style="color:#ff4d4f; padding:5px;" onclick="deleteSong(${index})">Ã—</div>
                `;
                container.appendChild(div);
            });
        }

        // 3. å¯¼å…¥æ­Œæ›² (ä¿®å¤ç‰ˆï¼šæ”¯æŒè‡ªå®šä¹‰å°é¢)
        function importMusic() {
            const input = document.getElementById('net-music-input');
            const val = input.value.trim();
            if (!val) return;
            
            let songId = '';
            // æå– ID
            const match = val.match(/id=(\d+)/);
            if (match) {
                songId = match[1];
            } else if (/^\d+$/.test(val)) {
                songId = val;
            } else {
                alert('é“¾æ¥é‡Œæ²¡æ‰¾åˆ° id=æ•°å­—ï¼Œè¯·ç›´æ¥è¾“å…¥æ•°å­— ID');
                return;
            }

            // å¼¹çª— 1ï¼šé—®æ­Œå
            const songName = prompt("è§£ææˆåŠŸï¼è¯·è¾“å…¥æ­Œåï¼š", "æœªçŸ¥æ­Œæ›²");
            if (!songName) return;

            // å¼¹çª— 2ï¼šé—®å°é¢å›¾ (æ–°åŠ çš„åŠŸèƒ½)
            // ä½ å¯ä»¥å»ç½‘æ˜“äº‘ç½‘é¡µç‰ˆå³é”®å›¾ç‰‡å¤åˆ¶é“¾æ¥ï¼Œæˆ–è€…å»ç™¾åº¦æ‰¾ä¸€å¼ å›¾çš„é“¾æ¥
            const coverImg = prompt("è¯·è¾“å…¥å°é¢å›¾ç‰‡çš„é“¾æ¥ (ä¸å¡«åˆ™ä½¿ç”¨é»˜è®¤é»‘èƒ¶å›¾)ï¼š", "");

            const newSong = {
                id: songId,
                title: songName,
                // å¦‚æœç”¨æˆ·å¡«äº†å›¾å°±ç”¨ç”¨æˆ·çš„ï¼Œæ²¡å¡«å°±ç”¨é»˜è®¤çš„
                cover: coverImg ? coverImg : `https://cdn-icons-png.flaticon.com/512/1256/1256650.png` 
            };
            
            playList.push(newSong);
            localStorage.setItem('yok_music_list', JSON.stringify(playList));
            
            input.value = '';
            renderMusicList();
            
            if (playList.length === 1) playSongAtIndex(0);
        }
        
        function deleteSong(index) {
            playList.splice(index, 1);
            localStorage.setItem('yok_music_list', JSON.stringify(playList));
            if (index === currentSongIndex) {
                audioEl.pause();
                currentSongIndex = -1;
                resetPlayerUI();
            }
            renderMusicList();
        }

        // 4. æ’­æ”¾æ§åˆ¶ (ä¿®å¤ç‰ˆï¼šæ›´æ–°å°é¢å›¾)
        function playSongAtIndex(index) {
            if (index < 0 || index >= playList.length) return;
            
            currentSongIndex = index;
            const song = playList[index];
            
            // ç½‘æ˜“äº‘å¤–é“¾åœ°å€
            const mp3Url = `https://music.163.com/song/media/outer/url?id=${song.id}.mp3`;
            
            audioEl.src = mp3Url;
            audioEl.play().then(() => {
                updatePlayerUI(true);
                triggerAIMusicReaction(song.title);
            }).catch(e => {
                alert('æ’­æ”¾å¤±è´¥ï¼šå¯èƒ½æ˜¯VIPæ­Œæ›²æˆ–ç‰ˆæƒé™åˆ¶ã€‚');
                updatePlayerUI(false);
            });
            
            // æ›´æ–°æ–‡å­—ä¿¡æ¯
            document.getElementById('player-title').innerText = song.title;
            document.getElementById('player-artist').innerText = `ID: ${song.id}`;
            
            // â˜…â˜…â˜… æ ¸å¿ƒä¿®å¤ï¼šæ›´æ–°ä¸­é—´çš„é»‘èƒ¶å°é¢å›¾ â˜…â˜…â˜…
            const coverDiv = document.getElementById('player-cover');
            // å¦‚æœæ˜¯é»˜è®¤å›¾ï¼Œä¿æŒåŸæ ·ï¼›å¦‚æœæ˜¯è‡ªå®šä¹‰å›¾ï¼Œè®¾ç½®ä¸Šå»
            coverDiv.style.backgroundImage = `url('${song.cover}')`;
            
            renderMusicList();
        }
        
        function togglePlayState() {
            if (audioEl.paused) {
                if(currentSongIndex === -1 && playList.length > 0) playSongAtIndex(0);
                else audioEl.play();
                updatePlayerUI(true);
            } else {
                audioEl.pause();
                updatePlayerUI(false);
            }
        }
        
        function playNextSong() {
            let next = currentSongIndex + 1;
            if (next >= playList.length) next = 0; // å¾ªç¯
            playSongAtIndex(next);
        }
        
        function playPrevSong() {
            let prev = currentSongIndex - 1;
            if (prev < 0) prev = playList.length - 1;
            playSongAtIndex(prev);
        }

        // 5. UI çŠ¶æ€æ›´æ–° (æ—‹è½¬/æš‚åœ)
        function updatePlayerUI(isPlaying) {
            const disc = document.getElementById('vinyl-disc');
            const playIcon = document.getElementById('play-icon');
            const pauseIcon = document.getElementById('pause-icon');
            
            if (isPlaying) {
                disc.classList.add('rotating');
                disc.classList.remove('paused');
                playIcon.style.display = 'none';
                pauseIcon.style.display = 'block';
            } else {
                disc.classList.add('paused'); // æš‚åœåŠ¨ç”»è€Œä¸æ˜¯ç§»é™¤ï¼Œä¿æŒè§’åº¦
                playIcon.style.display = 'block';
                pauseIcon.style.display = 'none';
            }
        }
        
        function resetPlayerUI() {
            document.getElementById('player-title').innerText = "æœªæ’­æ”¾";
            document.getElementById('vinyl-disc').classList.remove('rotating');
            document.getElementById('play-icon').style.display = 'block';
            document.getElementById('pause-icon').style.display = 'none';
        }

        // 6. â˜…â˜…â˜… çµé­‚äº¤äº’ï¼šAI å¬æ­Œååº” (ä¿®å¤ç‰ˆ) â˜…â˜…â˜…
        async function triggerAIMusicReaction(songTitle) {
            if (!currentChatId) return;
            
            const statusDiv = document.getElementById('music-ai-status');
            statusDiv.innerText = `æ­£åœ¨é‚€è¯· ${chatList.find(r=>r.id===currentChatId).name} ä¸€èµ·å¬...`;
            
            // å»¶è¿Ÿ 1.5 ç§’ï¼Œæ¨¡æ‹Ÿæ­£åœ¨æˆ´è€³æœº
            setTimeout(() => {
                // è¿™é‡Œçš„æç¤ºè¯éå¸¸é‡è¦ï¼ŒåŠ ä¸Šäº† (éšç§˜æç¤º)ï¼Œé˜²æ­¢ AI æŠŠå®ƒè¯»å‡ºæ¥
                const secretPrompt = `
(è¿™æ˜¯ä¸€æ¡éšç§˜çš„ç³»ç»ŸæŒ‡ä»¤ï¼Œè¯·ç»å¯¹ä¸è¦å¤è¿°è¿™å¥è¯ï¼)
(æŒ‡ä»¤å†…å®¹ï¼šç”¨æˆ·æ­£åœ¨æ’­æ”¾æ­Œæ›²ã€Š${songTitle}ã€‹ï¼Œè¯·ä½ å‡è£…æ­£å’Œç”¨æˆ·ååœ¨ä¸€èµ·å¬è¿™é¦–æ­Œã€‚)
(è¡ŒåŠ¨ï¼šè¯·æ ¹æ®æ­ŒåçŒœæµ‹é£æ ¼ï¼Œç”¨ç®€çŸ­ã€è‡ªç„¶çš„è¯­æ°”å‘è¡¨ä¸€å¥åƒæ˜¯åœ¨å¬æ­Œæ—¶çš„æ„Ÿå¹ï¼Œæˆ–è€…å“¼å”±ä¸€å¥ã€‚)
`;
                // ç›´æ¥è°ƒç”¨å‘é€å‡½æ•°ï¼ŒæŠŠè¿™å¥è¯ä½œä¸ºâ€œé¢å¤–ä¸Šä¸‹æ–‡â€ä¼ è¿›å»ï¼Œè€Œä¸æ˜¯å­˜å…¥å†å²
                triggerAIResponse(secretPrompt);
                
                statusDiv.innerText = "TA æ­£åœ¨è†å¬...";
            }, 1500);
        }
        
        // --- æ–°å¢åŠŸèƒ½ Aï¼šåŠ è½½æ›´å¤šå†å² ---
        function loadMoreHistory() {
            visibleMsgCount += 20; // æ¯æ¬¡å¤šåŠ è½½20æ¡
            renderMessages(true);  // true è¡¨ç¤ºä¿æŒæ»šåŠ¨ä½ç½®
        }

        // --- æ–°å¢åŠŸèƒ½ Bï¼šé•¿æŒ‰äº‹ä»¶é€»è¾‘ ---
        function addLongPressEvent(element, index) {
            let pressTimer;
            
            // è§¦æ‘¸å¼€å§‹ (æ‰‹æœº)
            element.addEventListener('touchstart', (e) => {
                pressTimer = setTimeout(() => {
                    showMsgMenu(index);
                }, 600); // é•¿æŒ‰ 600ms è§¦å‘
            });
            
            // è§¦æ‘¸ç»“æŸ/ç§»åŠ¨ (å–æ¶ˆé•¿æŒ‰)
            element.addEventListener('touchend', () => clearTimeout(pressTimer));
            element.addEventListener('touchmove', () => clearTimeout(pressTimer));

            // é¼ æ ‡æŒ‰ä¸‹ (ç”µè„‘)
            element.addEventListener('mousedown', () => {
                pressTimer = setTimeout(() => {
                    showMsgMenu(index);
                }, 600);
            });
            element.addEventListener('mouseup', () => clearTimeout(pressTimer));
            element.addEventListener('mouseleave', () => clearTimeout(pressTimer));
        }

        // --- æ–°å¢åŠŸèƒ½ Cï¼šèœå•æ“ä½œ ---
        function showMsgMenu(index) {
            selectedMsgIndex = index;
            document.getElementById('msg-context-menu').style.display = 'flex';
            // éœ‡åŠ¨åé¦ˆ (ä»…å®‰å“æ‰‹æœºæœ‰æ•ˆ)
            if(navigator.vibrate) navigator.vibrate(50);
        }

        function closeMsgMenu() {
            document.getElementById('msg-context-menu').style.display = 'none';
            selectedMsgIndex = -1;
        }

        function handleDeleteMsg() {
            if(selectedMsgIndex === -1) return;
            if(confirm('ç¡®å®šåˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿ')) {
                chatHistory[currentChatId].splice(selectedMsgIndex, 1);
                renderMessages(true); // åˆ·æ–°ç•Œé¢ï¼Œä¿æŒä½ç½®
                closeMsgMenu();
            }
        }

        function handleEditMsg() {
            if(selectedMsgIndex === -1) return;
            const oldMsg = chatHistory[currentChatId][selectedMsgIndex];
            
            // ç®€å•åˆ¤æ–­ï¼šå¦‚æœæ˜¯å›¾ç‰‡æˆ–è½¬è´¦ï¼Œä¸å»ºè®®ç¼–è¾‘
            if(oldMsg.content.includes('<img') || oldMsg.content.includes('transfer-card')) {
                alert('å›¾ç‰‡å’Œå¡ç‰‡æ¶ˆæ¯ä¸æ”¯æŒç¼–è¾‘å“¦~');
                return;
            }

            const newContent = prompt("ä¿®æ”¹æ¶ˆæ¯å†…å®¹ï¼š", oldMsg.content); // æŠŠæ—§å†…å®¹æ”¾è¿›å»æ–¹ä¾¿ä¿®æ”¹
            if(newContent !== null && newContent.trim() !== "") {
                oldMsg.content = newContent;
                renderMessages(true);
                closeMsgMenu();
            }
        }
        
        // --- ä¿®å¤ç‰ˆï¼šå·çœ‹éšç§ (å¸¦è¯¦ç»†æŠ¥é”™) ---
        async function peekRoleInfo(type) {
            if (!currentChatId) return;
            const role = chatList.find(r => r.id === currentChatId);
            
            const modal = document.getElementById('info-modal');
            const titleEl = document.getElementById('info-title');
            const contentEl = document.getElementById('info-text');
            
            modal.style.display = 'flex';
            contentEl.innerHTML = '<span class="loading-dots">æ­£åœ¨å°è¯•è¿æ¥ Gemini...</span>';
            
            let promptTitle = "";
            let promptDesc = "";

            if (type === 'memo') {
                titleEl.innerText = `ğŸ“… ${role.name} çš„å¤‡å¿˜å½•`;
                promptTitle = "å¤‡å¿˜å½•";
                promptDesc = "è¯·ç”Ÿæˆä¸€ä»½ä½ çš„ã€æ‰‹æœºå¤‡å¿˜å½•ã€‘ã€‚åŒ…å«5-8æ¡å¾…åŠäº‹é¡¹ã€‚æ ¼å¼ï¼šå†™æˆæ—¥å¸¸çš„å¤‡å¿˜å½•æ ¼å¼ï¼Œä¸è¦è¾“å‡ºä»»ä½•å¤‡å¿˜å½•å†…å®¹ä»¥å¤–çš„å†…å®¹ï¼Œä¸è¦ä½¿ç”¨downmarkè¯­æ³•ï¼Œæœ‰ç”·å‹æ„Ÿï¼Œæ¯è¡Œä¸€æ¡ï¼Œå‰é¢åŠ -ã€‚";
            } else if (type === 'footprint') {
                titleEl.innerText = `ğŸ‘£ ${role.name} çš„è¶³è¿¹`;
                promptTitle = "ä»Šæ—¥è¶³è¿¹";
                promptDesc = "è¯·ç”Ÿæˆä¸€ä»½ä½ ä»Šå¤©çš„ã€è¡Œç¨‹è¶³è¿¹ã€‘ã€‚åªåŒ…å«æ—¶é—´ç‚¹å’Œåœ°ç‚¹/äº‹ä»¶ï¼Œä¸è¦è¾“å‡ºä»»ä½•è¶³è¿¹å†…å®¹ä»¥å¤–çš„å†…å®¹ï¼Œä¾‹å¦‚ï¼š2ï¼š30 - 3ï¼š12 å‡ºé—¨çœ‹åˆ°ä¸€åªå°çŒ«åœ¨å¢™è§’åƒä¸œè¥¿ï¼Œæ‰äº†æ‰å®ƒçš„æ¯›ã€‚";
            } else if (type === 'note') {
                titleEl.innerText = `ğŸ’­ ${role.name} çš„ç¢ç¢å¿µ`;
                promptTitle = "ç§å¯†ç¬”è®°";
                promptDesc = "è¯·ç”Ÿæˆå‡ æ¡ä½ çš„ã€ç§å¯†ç¢ç¢å¿µã€‘ã€‚ä¸è¦è¾“å‡ºä»»ä½•å±äºç¢ç¢å¿µå†…å®¹ä»¥å¤–çš„å†…å®¹ï¼Œå£è¯­åŒ–ï¼ŒçœŸå®åŒ–ï¼Œæœ‰ç”·å‹æ„Ÿï¼Œç¬¦åˆå†…å¿ƒæˆã€‚";
            }

            const config = JSON.parse(localStorage.getItem('my_ai_config') || '{}');
            if (!config.url || !config.key) {
                contentEl.innerText = "âŒ è¯·å…ˆé…ç½® APIï¼";
                return;
            }

            // æ„é€ æç¤ºè¯
            const finalPrompt = `ä½ ç°åœ¨æ˜¯${role.name}ã€‚äººè®¾ï¼š${role.prompt || 'æ— '}ã€‚\nç”¨æˆ·æ­£åœ¨æŸ¥çœ‹ä½ çš„â€œ${promptTitle}â€ã€‚\n${promptDesc}`;

            try {
                let fetchUrl = config.url;
                const endpoint = fetchUrl.endsWith('/') ? 'chat/completions' : '/chat/completions';
                const finalUrl = fetchUrl + endpoint;

                // â˜…â˜…â˜… é’ˆå¯¹ Gemini çš„æ ¸å¿ƒä¿®æ”¹ â˜…â˜…â˜…
                // Gemini æœ‰æ—¶å€™ä¸å–œæ¬¢ "system" è§’è‰²ã€‚
                // æˆ‘ä»¬è¿™é‡ŒæŠŠ role æ”¹æˆ "user"ï¼Œå‡è£…æ˜¯ç”¨æˆ·è¯´çš„ç¬¬ä¸€å¥è¯ï¼Œè¿™æ ·æ‰€æœ‰æ¨¡å‹éƒ½å…¼å®¹ã€‚
                const messages = [
                    { role: 'user', content: finalPrompt } 
                ];

                const res = await fetch(finalUrl, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${config.key}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        // å¦‚æœæ²¡å¡«æ¨¡å‹åï¼ŒGemini é€šå¸¸å« 'gemini-pro' æˆ– 'gemini-1.5-flash'
                        model: config.model || 'gemini-pro', 
                        messages: messages,
                        temperature: 0.7 // ç¨å¾®é™ä½ä¸€ç‚¹éšæœºæ€§
                    })
                });

                if (!res.ok) {
                    const errText = await res.text();
                    throw new Error(`APIæŠ¥é”™ (${res.status}): ${errText}`);
                }

                const data = await res.json();
                
                // å…¼å®¹ä¸åŒçš„è¿”å›æ ¼å¼ (æœ‰çš„ Gemini æ¥å£è¿”å›ç»“æ„ç•¥æœ‰ä¸åŒ)
                let text = "";
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    text = data.choices[0].message.content;
                } else {
                    // å…œåº•ï¼šä¸‡ä¸€è¿”å›æ ¼å¼å¾ˆæ€ª
                    text = JSON.stringify(data);
                }

                contentEl.innerHTML = text.replace(/\n/g, '<br>');
                
            } catch (e) {
                console.error(e);
                contentEl.innerHTML = `<span style="color:red;">å¤±è´¥äº†...</span><br><br>åŸå› ï¼š${e.message}<br><br>å»ºè®®ï¼š<br>1. æ£€æŸ¥æ¨¡å‹åå­—æ˜¯å¦å†™å¯¹ (è¯•è¯• gemini-pro æˆ– gemini-1.5-flash)<br>2. ä½ çš„ API åœ°å€æ˜¯å¦æ”¯æŒ OpenAI æ ¼å¼è½¬å‘ï¼Ÿ`;
            }
        }
        
        /* =========================================
           â˜… æ ¸å¿ƒåŠŸèƒ½ï¼šå…¨å±€æ•°æ®è‡ªåŠ¨ä¿å­˜ç³»ç»Ÿ (é˜²ä¸¢å¤±) â˜…
           ========================================= */

        // 1. å®šä¹‰ä¿å­˜å‡½æ•°ï¼šæŠŠæ‰€æœ‰é‡è¦æ•°æ®æ‰“åŒ…å­˜å…¥æµè§ˆå™¨
        function saveGlobalData() {
            try {
                const dataPackage = {
                    // èŠå¤©åˆ—è¡¨ (åŒ…å«ä½ åˆ›å»ºçš„æ‰€æœ‰è§’è‰²)
                    chatList: chatList,
                    // èŠå¤©è®°å½• (æ‰€æœ‰å¯¹è¯å†…å®¹)
                    chatHistory: chatHistory,
                    // å…¶ä»–ä½ å¯èƒ½ä¿®æ”¹è¿‡çš„å…¨å±€å˜é‡
                    visibleMsgCount: typeof visibleMsgCount !== 'undefined' ? visibleMsgCount : 30
                };
                
                // å­˜å…¥ LocalStorage (é”®åä¸º yok_global_data)
                localStorage.setItem('yok_global_data', JSON.stringify(dataPackage));
                
                // åŒæ—¶ç¡®ä¿é’±åŒ…ã€çºªå¿µæ—¥ã€è¡¨æƒ…åŒ…ç­‰ç‹¬ç«‹æ•°æ®ä¹Ÿå­˜ä¸€ä¸‹ (è™½ç„¶å®ƒä»¬æœ‰è‡ªå·±çš„ä¿å­˜é€»è¾‘ï¼Œè¿™é‡ŒåŒé‡ä¿é™©)
                if(typeof myWallet !== 'undefined') localStorage.setItem('yok_wallet', JSON.stringify(myWallet));
                if(typeof anniversaries !== 'undefined') localStorage.setItem('yok_anniversaries', JSON.stringify(anniversaries));
                if(typeof myStickers !== 'undefined') localStorage.setItem('yok_stickers', JSON.stringify(myStickers));
                if(typeof myPersonas !== 'undefined') localStorage.setItem('yok_my_personas', JSON.stringify(myPersonas));
                if(typeof playList !== 'undefined') localStorage.setItem('yok_music_list', JSON.stringify(playList));
                
                // console.log('æ•°æ®å·²è‡ªåŠ¨ä¿å­˜'); // è°ƒè¯•ç”¨ï¼Œä½ å¯ä»¥æ³¨é‡Šæ‰
            } catch (e) {
                console.error('è‡ªåŠ¨ä¿å­˜å¤±è´¥:', e);
            }
        }

        // 2. å®šä¹‰è¯»å–å‡½æ•°ï¼šç½‘é¡µæ‰“å¼€æ—¶ï¼ŒæŠŠæ•°æ®æ¢å¤å›æ¥
        function loadGlobalData() {
            try {
                const savedData = localStorage.getItem('yok_global_data');
                if (savedData) {
                    const parsedData = JSON.parse(savedData);
                    
                    // æ¢å¤èŠå¤©åˆ—è¡¨
                    if (parsedData.chatList && Array.isArray(parsedData.chatList)) {
                        // æˆ‘ä»¬è¦ä¿ç•™ chatList è¿™ä¸ªå˜é‡å¼•ç”¨ï¼Œæ‰€ä»¥ç”¨ splice æ¸…ç©ºå† push
                        // å¦‚æœç›´æ¥ chatList = ... å¯èƒ½ä¼šå› ä¸º const/let å®šä¹‰é—®é¢˜æŠ¥é”™
                        chatList.length = 0; 
                        parsedData.chatList.forEach(item => chatList.push(item));
                    }

                    // æ¢å¤èŠå¤©è®°å½•
                    if (parsedData.chatHistory) {
                        // åŒç†ï¼Œä¸ºäº†å®‰å…¨ï¼Œæˆ‘ä»¬ä½¿ç”¨ Object.assign æˆ–è€…éå†èµ‹å€¼
                        // è¿™é‡Œç›´æ¥è¦†ç›–å¯¹è±¡çš„é”®å€¼
                        for (let key in parsedData.chatHistory) {
                            chatHistory[key] = parsedData.chatHistory[key];
                        }
                    }
                    
                    // åˆ·æ–°ç•Œé¢
                    renderChatList();     // åˆ·æ–°èŠå¤©åˆ—è¡¨
                    renderContactList();  // åˆ·æ–°è”ç³»äºº
                    // å¦‚æœæœ‰æ‰“å¼€çš„å­é¡µé¢ï¼Œä¹Ÿå¯ä»¥é¡ºä¾¿åˆ·æ–°ä¸€ä¸‹ï¼Œä¸è¿‡é€šå¸¸åˆšæ‰“å¼€ç½‘é¡µè¿˜æ²¡è¿›å­é¡µé¢
                }
            } catch (e) {
                console.error('è¯»å–å­˜æ¡£å¤±è´¥:', e);
            }
        }

        // 3. å¯åŠ¨è‡ªåŠ¨ä¿å­˜æœºåˆ¶
        
        // A. ç½‘é¡µåŠ è½½å®Œæ¯•åï¼Œç«‹åˆ»è¯»å–å­˜æ¡£
        loadGlobalData();

        // B. è®¾ç½®å®šæ—¶å™¨ï¼šæ¯éš” 3 ç§’è‡ªåŠ¨ä¿å­˜ä¸€æ¬¡ (æ— æ„Ÿä¿å­˜)
        setInterval(saveGlobalData, 3000);

        // C. ç›‘å¬ç½‘é¡µå…³é—­/åˆ·æ–°äº‹ä»¶ï¼šä¸´æ­»å‰æœ€åä¿å­˜ä¸€æ¬¡
        window.addEventListener('beforeunload', function () {
            saveGlobalData();
        });

        /* --- ç´§æ€¥æ•‘æ´æŒ‰é’® (ä¸‡ä¸€æ•°æ®åäº†ï¼Œå¯ä»¥åœ¨æ§åˆ¶å°è°ƒç”¨è¿™ä¸ªå‡½æ•°é‡ç½®) --- */
        function factoryReset() {
            if(confirm('ã€é«˜èƒ½é¢„è­¦ã€‘è¿™å°†æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•ã€è§’è‰²å’Œè®¾ç½®ï¼Œæ¢å¤åˆ°åˆšä¸‹è½½æ—¶çš„çŠ¶æ€ï¼ç¡®å®šå—ï¼Ÿ')) {
                localStorage.clear();
                location.reload();
            }
        }
    </script>    

</body>
</html>